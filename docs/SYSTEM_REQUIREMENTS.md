# インサイダーゲーム V2 - システム要件

## プロジェクト概要

### 目的
オンラインでプレイ可能なインサイダーゲームのWebアプリケーションを開発する。音声通話（Discord/LINE等）と併用し、ゲームの進行管理とUI表示を担当する。

### 対象ユーザー
- 3〜12人のグループ
- 音声通話可能な環境
- モバイルデバイス優先（スマートフォン、タブレット）

## 技術スタック

### フロントエンド
- **フレームワーク**: Next.js 15.5.4（App Router）
- **言語**: TypeScript 5.x
- **UI ライブラリ**: React 19.1.0
- **スタイリング**: Tailwind CSS 4.x
- **コンポーネント**: Radix UI（アクセシビリティ対応）
- **アイコン**: Lucide React
- **フォント**: Noto Sans JP（日本語最適化）

### バックエンド（予定）
- **データベース**: Supabase（PostgreSQL）
- **リアルタイム通信**: Supabase Realtime
- **認証**: Supabase Auth（オプション）
- **ホスティング**: Vercel

## 機能要件

### 1. ルーム管理

#### 1.1 ルーム作成
- **入力項目**:
  - 合言葉（パスフレーズ）: 最大20文字
  - プレイヤー名: 最大10文字
- **処理フロー**:
  1. ユーザーが合言葉とプレイヤー名を入力
  2. システムがルームIDを生成（6文字の英数字）
  3. ユーザーをホストとしてロビーへ遷移
- **バリデーション**:
  - 合言葉とプレイヤー名は必須
  - 空白のみの入力は不可

#### 1.2 ルーム参加
- **入力項目**:
  - ルームID: 6文字
  - 合言葉: 20文字まで
  - プレイヤー名: 最大10文字
- **処理フロー**:
  1. ユーザーがルームID、合言葉、プレイヤー名を入力
  2. システムが認証を確認
  3. 認証成功でロビーへ参加
- **エラーハンドリング**:
  - ルームが存在しない
  - 合言葉が不正
  - ルームが満員（12人）
  - ゲーム進行中

### 2. ロビー

#### 2.1 プレイヤー管理
- **表示情報**:
  - プレイヤー名
  - ホスト表示（王冠アイコン）
  - 準備完了ステータス
  - 現在のプレイヤー（自分）の強調表示
  - 現在のページステータス（「結果確認中」等）
- **機能**:
  - リアルタイムプレイヤーリスト更新
  - プレイヤー数カウント（現在/最大12人）
  - 空きスロット表示


#### 2.2 ゲーム設定（ホストのみ）
- **制限時間設定**:
  - 選択肢: 3分、5分、7分、10分、15分
  - デフォルト: 5分
- **お題カテゴリ設定**:
  - 選択肢: 全般、動物、食べ物、場所、物
  - デフォルト: 全般

#### 2.3 ゲーム開始条件
- 最低3人のプレイヤーが必要
- 全プレイヤーが準備完了
- ホストのみが開始可能

### 3. ゲームフロー

#### 3.1 役職配布フェーズ
- **役職**:
  - **マスター**: お題を知っている。質問に答える役
  - **インサイダー**: お題を知っている。バレないように誘導する役
  - **庶民**: お題を知らない。質問してお題を当てる役
- **処理**:
  1. システムがランダムに役職を配布
  2. 各プレイヤーに役職を表示
  3. 全員が確認するまで待機
- **UI表示**:
  - 役職アイコン
  - 役職名（大きく表示）
  - 役職説明
  - 確認ボタン
  - 確認済みプレイヤー数

#### 3.2 お題確認フェーズ
- **対象**: マスターとインサイダーのみ
- **表示内容**:
  - お題を大きく表示
  - 確認ボタン
- **処理**:
  - 全員が確認したら質問フェーズへ自動遷移

#### 3.3 質問フェーズ
- **制限時間**: 設定された時間（デフォルト5分）
- **UI要素**:
  - タイマー（円形プログレスバー）
  - マスターのみお題を表示
  - 進行方法の説明
- **進行**:
  - プレイヤーは音声でマスターに質問
  - マスターは「はい」「いいえ」で回答
  - 正解が出たらマスターがボタンを押す
- **終了条件**:
  - マスターが「正解が出ました」ボタンを押す → 討論フェーズへ
  - 時間切れ → 全員敗北（結果画面へ）

#### 3.4 討論フェーズ
- **制限時間**: 質問フェーズの残り時間を引き継ぐ（最大3分）
- **UI要素**:
  - タイマー（円形プログレスバー）
  - 正解者表示（タイマー下に「🎉 〇〇 さんが正解しました」と表示）
  - 「質問履歴を見る」ボタン（質問フェーズのQ&A履歴をモーダルで表示）
  - 討論の進め方説明
- **質問履歴モーダル**:
  - 質問者のニックネーム
  - 質問内容
  - マスターの回答（はい/いいえ）
  - 投稿時刻
  - 時系列順（古い順）で表示
- **進行**:
  - プレイヤーは音声で議論
  - 誰がインサイダーかを推測
  - 質問履歴を振り返りながら議論可能
- **終了条件**:
  - 時間切れ → 第一投票フェーズへ自動遷移

#### 3.5 第一投票フェーズ
- **投票内容**: 「正解者がインサイダーか？」
- **選択肢**: はい / いいえ
- **UI表示**:
  - 正解者の名前を表示
  - 大きな投票ボタン（はい/いいえ）
  - 投票済みの場合は選択内容を表示
  - 投票済みプレイヤー数
- **判定**:
  - 「はい」が過半数 → 第二投票フェーズへ
  - 「いいえ」が過半数 → インサイダー勝利（結果画面へ）

#### 3.6 第二投票フェーズ
- **投票内容**: 「誰がインサイダーか？」
- **選択肢**: 自分とマスター以外のプレイヤー（※マスターはインサイダー候補にならないため）
- **UI表示**:
  - プレイヤーリスト（選択可能）
  - 投票済みの場合は選択したプレイヤーを表示
  - 投票済みプレイヤー数
- **判定**:
  - 最多得票者がインサイダー → 庶民勝利
  - 最多得票者がインサイダーでない → インサイダー勝利
  - 同票の場合 → インサイダー勝利

#### 3.7 結果フェーズ
- **表示内容**:
  - 勝敗結果（大きく表示）
  - 各プレイヤーの役職公開
  - お題の表示
  - MVP表示（オプション）
- **アクション**:
  - もう一度遊ぶ（ロビーへ戻る）
  - ホーム画面へ戻る
- **ステータス管理**:
  - 結果画面にいるプレイヤーは「結果確認中」ステータスで他プレイヤーに表示
  - 60秒経過で自動的にロビーへ遷移
  - ロビー遷移時に準備完了ステータスをリセット


## 非機能要件

### パフォーマンス
- ページロード時間: 2秒以内
- リアルタイム更新遅延: 500ms以内
- 同時接続: 最大12人/ルーム

### セキュリティ
- 合言葉のハッシュ化
- ルームIDの推測困難性
- 不正な役職変更の防止

### 可用性
- 99%以上の稼働率
- エラー時の適切なメッセージ表示
- ネットワーク切断時の再接続機能

### ユーザビリティ
- モバイルファースト設計
- タップ可能領域: 最低44px×44px
- 明確なフィードバック（ローディング、成功、エラー）
- アクセシビリティ対応（ARIA属性、キーボード操作）

### 拡張性
- お題データの追加・管理
- 新しいゲームモードの追加可能性
- 統計・履歴機能の追加可能性

## データモデル（予定）

### Rooms（ルーム）
```typescript
{
  id: string // ルームID（6文字）
  passphrase_hash: string // 合言葉ハッシュ
  host_id: string // ホストのプレイヤーID
  time_limit: number // 制限時間（分）
  category: string // お題カテゴリ
  status: 'lobby' | 'playing' | 'finished'
  created_at: timestamp
  updated_at: timestamp
}
```

### Players（プレイヤー）
```typescript
{
  id: string // プレイヤーID
  room_id: string // ルームID
  name: string // プレイヤー名
  is_host: boolean // ホストフラグ
  is_ready: boolean // 準備完了フラグ
  current_page: string // 現在のページ（lobby, result等）
  joined_at: timestamp
}
```


### GameSessions（ゲームセッション）
```typescript
{
  id: string // セッションID
  room_id: string // ルームID
  topic: string // お題
  phase: 'role_assignment' | 'topic' | 'question' | 'debate' | 'vote1' | 'vote2' | 'result'
  started_at: timestamp
  ended_at: timestamp | null
}
```

### Roles（役職割り当て）
```typescript
{
  id: string
  game_session_id: string
  player_id: string
  role: 'master' | 'insider' | 'common'
  confirmed: boolean
}
```

### Votes（投票）
```typescript
{
  id: string
  game_session_id: string
  player_id: string
  vote_type: 'vote1' | 'vote2'
  target: string | boolean // vote1: boolean, vote2: player_id
  voted_at: timestamp
}
```

## API エンドポイント（予定）

### ルーム管理
- `POST /api/rooms` - ルーム作成
- `POST /api/rooms/join` - ルーム参加
- `GET /api/rooms/:roomId` - ルーム情報取得
- `DELETE /api/rooms/:roomId` - ルーム削除

### ゲームセッション
- `POST /api/games/start` - ゲーム開始
- `POST /api/games/assign-roles` - 役職配布
- `POST /api/games/next-phase` - 次フェーズへ遷移
- `POST /api/games/vote` - 投票
- `GET /api/games/result` - 結果取得

### リアルタイム（Supabase Realtime）
- `rooms:room_id` - プレイヤー参加/退出、設定変更
- `game_sessions:session_id` - フェーズ変更、タイマー同期
- `votes:session_id` - 投票状況

## 開発フェーズ

### Phase 1: 基盤構築
- [ ] プロジェクトセットアップ
- [ ] Supabase接続
- [ ] 認証機能（オプション）
- [ ] データベーススキーマ作成

### Phase 2: ルーム機能
- [ ] ルーム作成・参加UI
- [ ] ロビー画面
- [ ] リアルタイムプレイヤー同期
- [ ] ゲーム設定

### Phase 3: ゲームロジック
- [ ] 役職配布
- [ ] お題管理
- [ ] フェーズ遷移
- [ ] タイマー同期

### Phase 4: 投票・結果
- [ ] 第一投票
- [ ] 第二投票
- [ ] 結果画面
- [ ] 勝敗判定

### Phase 5: テスト・デプロイ
- [ ] E2Eテスト
- [ ] パフォーマンステスト
- [ ] Vercelデプロイ
- [ ] 本番環境動作確認

## 参考プロトタイプ
プロトタイプは `online-board-game/` ディレクトリに格納されています。
