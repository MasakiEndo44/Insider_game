# システム要件定義書

最終更新: 2025-10-20
バージョン: 1.0

---

## システム概要

**インサイダーゲーム オンライン版**は、人気ボードゲーム「インサイダー」をブラウザベースのオンライン対戦アプリとして実現するシステムです。3〜12人のプレイヤーがDiscordなどの音声通話と連携しながら、役職の秘匿管理、タイマー制御、投票システムを活用してゲームを進行します。

### 1. システムの目的

**解決する具体的な課題:**
- オフラインゲームのオンライン化による物理的距離の制約解消
- 手動進行の負担軽減（タイマー管理、投票集計、役職秘匿の自動化）
- 中断・再接続への対応不足による体験品質の低下

**目標とする成果:**
- 3〜12人規模のオンライン友人グループが気軽にプレイできる環境構築
- ゲームマスター不要の自動進行システムによる負担軽減
- 中断・再開・再接続に強い安定したオンライン体験の提供

**期待されるビジネスインパクト:**
- 初期段階: 30名程度の同時接続を無料で実現（Supabase Free tier活用）
- ユーザー獲得: 友人グループ、オンラインコミュニティでの口コミ拡散
- 将来展望: スコアシステム、ランキング機能などの拡張可能性

### 2. 主な機能

**コア機能（ゲームの根幹）:**
1. **ルーム管理**: 合言葉（3〜10文字、日本語対応）によるルーム作成・参加
2. **役職配布**: マスター・インサイダー・庶民の自動割り当て（前回マスター除外ロジック）
3. **お題配信**: 難易度別お題のランダム選択と役職別秘匿表示
4. **タイマー同期**: サーバーepoch基準の5分質問フェーズ＋残り時間継承の討論フェーズ
5. **投票システム**: 第一投票（Yes/No）→第二投票（候補選択＋決選投票×2）

**差別化機能（競合優位性）:**
1. **中断・再開機能**: ゲーム状態のスナップショット保存と完全復元
2. **再接続ロバスト性**: フェーズ終了まで無制限の再接続許容
3. **同票処理の厳密性**: 最大2回の決選投票、3回同票でインサイダー勝利

**付加価値機能（UX向上）:**
1. **モバイル最適化**: iPhone片手操作対応UI（44pxタップ領域、下部固定ボタン）
2. **アクセシビリティ**: アイコン＋ラベルによる役職表示（色だけに依存しない）

### 3. 提供する価値

**ユーザーにとっての直接的価値:**
- 物理的距離を超えた友人とのゲーム体験
- 進行管理の負担なく純粋にゲームを楽しめる
- 通信トラブルに強い安心感

**ビジネスにとっての価値:**
- 低コスト運用（Supabase Free tier + Vercel無料枠）
- スケーラブルな技術選定（必要に応じてPro tier移行）
- 将来的な機能拡張の基盤構築

**社会的価値:**
- オンラインコミュニケーションの促進
- ボードゲーム文化のデジタル化推進

### 4. 実現方法の概要

**主要なテクノロジー要素:**
- **フロントエンド**: Next.js 14 (App Router) + TypeScript + Tailwind CSS
- **状態管理**: XState（フェーズ遷移のステートマシン化）
- **バックエンド**: Supabase (PostgreSQL + Realtime + Edge Functions)
- **認証**: 匿名認証（ニックネームベース、アカウント不要）

**重要なインテグレーションポイント:**
- Supabase Realtimeによるルーム単位のリアルタイム同期
- Row Level Security (RLS) による役職・お題の秘匿保証
- Vercel Edge Runtimeでのデプロイ最適化

**スケーラビリティへの考慮:**
- ルーム単位のチャネル購読（ブロードキャスト最小化）
- Edge Functionsによるサーバーレス処理
- 24時間自動削除による古いルームのクリーンアップ

---

## 情報の前提と仮定

### 使用した情報源
1. `docs/インサイダー_オンライン対戦アプリ概要（実装図ベース）.md` - プロダクト概要
2. `docs/20251019_インサイダー実装図一覧.md` - フローチャート、シーケンス図、DB設計
3. ブレインストーミングでの意思決定（22項目の質問への回答）

### 置いた仮定
- **ユーザー規模**: 初期30名同時接続（5ルーム×6名想定）
- **利用シーン**: 友人グループ、オンラインサークル、社内懇親
- **音声通話**: Discord/LINE等の外部ツール利用（アプリ内音声は実装しない）
- **運用体制**: 個人開発または小規模チーム、24時間監視なし
- **コスト制約**: 初期無料運用（Supabase Free tier + Vercel Hobby plan）

---

## 機能要件

### FR-001: ルーム管理

#### FR-001-1: ルーム作成
- **優先度**: 高
- **説明**: ユーザーが合言葉を設定してルームを作成
- **詳細要件**:
  - 合言葉: 3〜10文字、Unicode対応（日本語可）
  - 重複チェック: 既存の合言葉との重複を禁止
  - セキュリティ: Argon2idによるハッシュ化保存
  - 作成者自動割り当て: 作成者がホストとして自動参加
- **受け入れ基準**:
  - 2文字以下・11文字以上の合言葉はエラー表示
  - 既存合言葉との重複時にエラー表示
  - ルーム作成後、即座にロビー画面へ遷移

#### FR-001-2: ルーム参加
- **優先度**: 高
- **説明**: 合言葉を入力して既存ルームに参加
- **詳細要件**:
  - 存在確認: 合言葉に一致するルームが存在するか検証
  - ニックネーム重複処理: 同名ユーザーがいる場合「-2」を自動付加
  - リアルタイム反映: 参加者全員に新規参加を即座に通知
- **受け入れ基準**:
  - 存在しない合言葉入力時にエラー表示
  - ニックネーム重複時に自動サフィックス付加
  - 全参加者の画面に新規参加者が即座に表示

#### FR-001-3: ルーム自動削除
- **優先度**: 中
- **説明**: 中断後24時間経過したルームを自動削除
- **詳細要件**:
  - スケジューラー: Supabase Cron jobまたはEdge Functionで定期実行
  - 削除条件: `is_suspended = true AND updated_at < now() - interval '24 hours'`
  - 通知: 削除実行時はログ記録のみ（ユーザー通知なし）
- **受け入れ基準**:
  - 中断後24時間経過したルームが自動削除される
  - アクティブなルームは削除されない

### FR-002: 役職配布

#### FR-002-1: ランダム役職割り当て
- **優先度**: 高
- **説明**: マスター・インサイダー・庶民を自動割り当て
- **詳細要件**:
  - マスター選出: 前回マスターを除外した候補からランダム（初回は全員対象）
  - インサイダー選出: マスターを除いた候補からランダム
  - 庶民: 残り全員
  - 履歴保存: 次回ラウンドのために前回マスターIDを保存
- **受け入れ基準**:
  - 100回実行して統計的に偏りがない（マスター選出確率 ≈ 1/N）
  - 前回マスターが連続でマスターにならない
  - 全員に役職が割り当てられる

#### FR-002-2: 役職秘匿表示
- **優先度**: 高（セキュリティクリティカル）
- **説明**: 各プレイヤーに自分の役職のみを表示
- **詳細要件**:
  - RLSポリシー: `SELECT roles WHERE player_id = auth.uid() OR session.phase = 'RESULT'`
  - カード表示:
    - マスター: 「あなたはマスターです！」+ 「!」アイコン
    - インサイダー: 「あなたはインサイダーです👁」+ 目アイコン
    - 庶民: 「あなたは庶民です？」+ 「?」アイコン
- **受け入れ基準**:
  - ブラウザDevToolsで他プレイヤーの役職が取得できない
  - 各プレイヤーに正しい役職カードが表示される

### FR-003: お題配信

#### FR-003-1: お題選択ロジック
- **優先度**: 高
- **説明**: 難易度とセッション内重複を考慮したお題選択
- **詳細要件**:
  - お題データ: Easy 50問、Normal 50問、Hard 30問（合計130問）
  - フィルタリング:
    1. 選択された難易度に一致するお題のみ抽出
    2. 同一セッション内で既に使用されたお題を除外
    3. 残りからランダム選択
  - 重複管理: `used_topics` テーブルに選択済みお題を記録
- **受け入れ基準**:
  - 同一セッション内で同じお題が2回選択されない
  - 難易度に応じた適切なお題が選択される

#### FR-003-2: 役職別お題表示
- **優先度**: 高（セキュリティクリティカル）
- **説明**: マスターとインサイダーにのみお題を表示
- **詳細要件**:
  - マスター: 画面上部に常時小さく表示（固定位置）
  - インサイダー: 10秒間のポップアップ表示後、自動消去
  - 庶民: 「お題を確認中...」のメッセージのみ表示
  - RLSポリシー: `SELECT topics WHERE role IN ('MASTER', 'INSIDER')`
- **受け入れ基準**:
  - 庶民のブラウザDevToolsでお題が取得できない
  - インサイダーのポップアップが正確に10秒で消える
  - マスターの画面で常時お題が見える

### FR-004: タイマー管理

#### FR-004-1: 質問フェーズタイマー
- **優先度**: 高
- **説明**: 5分間の質問フェーズ（全難易度共通）
- **詳細要件**:
  - サーバー側計算: `deadline_epoch = now() + 300` （300秒 = 5分）
  - クライアント側表示: `remaining = deadline_epoch - Math.floor(Date.now() / 1000)`
  - 更新頻度: 100ms間隔（滑らかなカウントダウン）
  - タイムアウト処理: 5分経過で「全員敗北」として結果フェーズへ
- **受け入れ基準**:
  - 複数クライアントで±1秒以内の誤差
  - タイムアウト時に正しく全員敗北判定

#### FR-004-2: 正解報告と時間継承
- **優先度**: 高
- **説明**: マスターの正解報告で残り時間を討論フェーズに継承
- **詳細要件**:
  - 経過時間計算: `elapsed = now() - start_time`
  - 残り時間計算: `remaining = 300 - elapsed`
  - 討論締切設定: `debate_deadline = now() + remaining`
  - サーバー側検証: 正解報告時刻が `<= deadline_epoch` であることを確認
- **受け入れ基準**:
  - 質問フェーズ4分59秒で正解 → 討論フェーズ1秒
  - 質問フェーズ1分で正解 → 討論フェーズ4分
  - タイムアウト後の正解報告は無視される

#### FR-004-3: 討論フェーズタイマー
- **優先度**: 高
- **説明**: 質問フェーズの残り時間を引き継ぎ
- **詳細要件**:
  - 最低時間保証なし（仕様通り、残り1秒でも1秒のみ）
  - ホスト手動終了: 討論フェーズ中にホストが「討論終了」ボタンで強制終了可能
  - 自動終了: タイマー0秒で自動的に第一投票フェーズへ
- **受け入れ基準**:
  - 残り時間が正確に継承される
  - ホスト手動終了が即座に反映される

### FR-005: 投票システム

#### FR-005-1: 第一投票（告発投票）
- **優先度**: 高
- **説明**: 正解者をインサイダーとして告発するか投票
- **詳細要件**:
  - 選択肢: Yes（告発する）/ No（告発しない）
  - UI: 大きなタップ領域（44px以上）、誤タップ防止
  - 集計: 全員投票完了で即座に集計開始
  - 過半数判定: `yes_count > total_count / 2`
  - 結果分岐:
    - Yes過半数 → 正解者の役職公開 → 勝敗判定 → 結果フェーズ
    - No過半数 → 第二投票フェーズへ
- **受け入れ基準**:
  - 6人中4人がYes → Yes過半数
  - 6人中3人がYes → No過半数（第二投票へ）

#### FR-005-2: 第二投票（候補選択）
- **優先度**: 高
- **説明**: 自分とマスターを除く候補から1名選択（※正解者にも再度投票可能）
- **詳細要件**:
  - 候補生成: 全プレイヤー - {自分, マスター}（※マスターはインサイダー候補にならないため除外）
  - UI: ラジオボタン形式の単一選択リスト
  - 集計: 全員投票完了で集計開始
  - 最多票判定:
    - 最多票が1人のみ → その人の役職公開 → 勝敗判定
    - 同票複数 → 決選投票フェーズへ
- **受け入れ基準**:
  - 自分とマスターが候補に含まれない
  - 最多票者が正しく特定される

#### FR-005-3: 決選投票
- **優先度**: 高
- **説明**: 同票者のみで最大2回の決選投票
- **詳細要件**:
  - 候補: 前回同票だった人のみ
  - 回数制限: 最大2回まで
  - 3回目同票: インサイダー逃げ切り勝利で結果フェーズへ
  - 決選での再同票: さらに次の決選へ（最大2回まで）
- **受け入れ基準**:
  - 2回決選後も同票 → インサイダー勝利
  - 決選で最多票確定 → その人の役職公開

#### FR-005-4: 再投票（ホスト権限）
- **優先度**: 中
- **説明**: 第二投票で1回のみ再投票可能
- **詳細要件**:
  - 権限: ホストのみ
  - 回数制限: 1回のみ（`retry_used` フラグで管理）
  - 対象: 第二投票のみ（決選投票では使用不可）
  - リセット: 全員の投票をクリアし、同じ候補で再投票
- **受け入れ基準**:
  - 1回目の再投票は成功
  - 2回目の再投票リクエストはエラー

### FR-006: 中断・再開機能

#### FR-006-1: 中断処理
- **優先度**: 高
- **説明**: ホストが任意のフェーズでゲームを中断
- **詳細要件**:
  - 権限: ホストのみ
  - スナップショット保存: 現在のフェーズ、タイマー残り時間、投票状況、正解者IDをJSONB形式で保存
  - 状態更新: `phase = 'LOBBY'`, `is_suspended = true`
  - 通知: 全プレイヤーにRealtime通知、ロビー画面へ遷移
- **受け入れ基準**:
  - 中断後、全プレイヤーがロビー画面に戻る
  - スナップショットが正しく保存される

#### FR-006-2: 再開処理
- **優先度**: 高
- **説明**: 中断時のメンバー全員が揃ったら再開可能
- **詳細要件**:
  - メンバーチェック: 中断時のプレイヤーIDリストと現在の参加者を比較
  - 再開条件: 全員参加かつホストが「対戦を再開」押下
  - 状態復元: スナップショットから各データを読み込み
  - タイマー再計算: `new_deadline = now() + saved_remaining_time`
- **受け入れ基準**:
  - メンバー不足時はエラー表示
  - 全員揃った状態で再開すると中断時のフェーズに復帰

### FR-007: 再接続機能

#### FR-007-1: 自動再接続
- **優先度**: 高
- **説明**: ネットワーク切断時の自動再接続
- **詳細要件**:
  - Heartbeat監視: Supabase Realtimeの接続状態を監視
  - タイムアウト: 10秒間応答なしで切断と判定
  - 再接続試行: 指数バックオフで自動リトライ（1秒、2秒、4秒、8秒...）
  - 接続状態表示: 「再接続中...」メッセージ表示
- **受け入れ基準**:
  - ネットワーク復旧後、自動的に再接続される
  - 他プレイヤーに切断・再接続が通知される

#### FR-007-2: 状態復元
- **優先度**: 高
- **説明**: 再接続後に現在フェーズへ復帰
- **詳細要件**:
  - 現在フェーズ取得: サーバーから最新のゲーム状態を取得
  - 投票状態確認:
    - 投票フェーズ中 → 未投票なら投票画面、投票済みなら結果待ち画面
  - タイマー同期: deadline_epochから残り時間を再計算
  - 再接続猶予: フェーズ終了まで無制限に再接続可能
- **受け入れ基準**:
  - 投票フェーズで再接続 → 未投票なら投票可能
  - タイマーフェーズで再接続 → 残り時間が正しく表示される

### FR-008: 結果表示・次ラウンド

#### FR-008-1: 結果画面
- **優先度**: 高
- **説明**: 勝敗と全員の役職を公開
- **詳細要件**:
  - 勝敗表示: 「庶民勝利！」「インサイダー勝利！」「全員敗北」
  - 役職公開: 全プレイヤーの役職を一覧表示
  - アニメーション: フェードイン効果で順次表示
- **受け入れ基準**:
  - 勝敗が正しく表示される
  - 全員の役職が公開される

#### FR-008-2: 次ラウンド
- **優先度**: 中
- **説明**: 同じメンバーで次のゲームを開始
- **詳細要件**:
  - 権限: ホストのみ
  - 状態リセット: 役職、お題、投票データをクリア
  - 履歴保持: 前回マスターIDは保持（次回の役職配布で使用）
  - メンバー変動確認: 参加者に増減があれば警告ダイアログ
- **受け入れ基準**:
  - 次ラウンド開始で役職配布フェーズへ遷移
  - 前回マスターが連続でマスターにならない

---

## 非機能要件

### NFR-001: パフォーマンス

#### NFR-001-1: レスポンスタイム
- **目標値**:
  - 画面遷移: 500ms以内
  - Realtime通知反映: 500ms以内（サーバー書き込みからクライアント受信まで）
  - API応答: 200ms以内（P95）
- **根拠**: 30名同時接続、5ルーム並行を想定。Supabase Free tierの制約内で実現可能。
- **測定方法**: Vercel Analytics、Supabase Dashboard

#### NFR-001-2: 同時接続数
- **目標値**: 30名同時接続（5ルーム×6名）
- **根拠**: Supabase Free tier制約（50,000 MAU、2GB帯域/月）
- **スケーリング計画**: ユーザー増加時はPro tier ($25/月) へ移行

#### NFR-001-3: データベースクエリ
- **目標値**: N+1クエリの排除、インデックス活用
- **実装**:
  - `rooms.passphrase` にUNIQUEインデックス
  - `players.room_id` に外部キーインデックス
  - `roles (session_id, player_id)` に複合ユニークインデックス

### NFR-002: セキュリティ

#### NFR-002-1: 認証・認可
- **要件**:
  - 匿名認証（Supabase Anonymous Auth）
  - ニックネームベースのセッション管理
  - RLSポリシーによる役職・お題の秘匿
- **実装**:
  ```sql
  -- 役職秘匿ポリシー
  CREATE POLICY "role_secrecy" ON roles
    FOR SELECT USING (
      player_id = auth.uid() OR
      (SELECT phase FROM game_sessions WHERE id = session_id) = 'RESULT'
    );

  -- お題秘匿ポリシー
  CREATE POLICY "topic_secrecy" ON topics
    FOR SELECT USING (
      EXISTS (
        SELECT 1 FROM roles
        WHERE session_id = topics.session_id
        AND player_id = auth.uid()
        AND role IN ('MASTER', 'INSIDER')
      )
    );
  ```

#### NFR-002-2: データ保護
- **要件**:
  - 合言葉: Argon2idハッシュ化（コスト係数: 時間2、メモリ19MB、並列度1）
  - HTTPS必須（Vercel自動提供）
  - XSS対策: Next.jsデフォルトのエスケープ処理
  - CSRF対策: SameSite Cookie属性
- **実装**: `@node-rs/argon2` ライブラリ使用

#### NFR-002-3: 入力検証
- **要件**:
  - 合言葉: 3〜10文字、Unicode正規化（NFC）
  - ニックネーム: 1〜20文字、特殊文字除外
  - SQLインジェクション対策: Supabase Prepared Statements

### NFR-003: 可用性

#### NFR-003-1: エラーハンドリング
- **要件**:
  - ネットワークエラー: 自動リトライ（指数バックオフ）
  - データベースエラー: エラートースト表示＋再試行ボタン
  - タイムアウト: 10秒でタイムアウト、再接続誘導
- **ログ**: Vercel Runtime Logsに記録

#### NFR-003-2: 障害復旧
- **要件**:
  - サーバー障害: Supabaseの自動フェイルオーバー（99.9% SLA）
  - クライアント障害: ページリロードで状態復元
  - データ整合性: トランザクション処理（投票集計、フェーズ遷移）

### NFR-004: ユーザビリティ

#### NFR-004-1: モバイル対応
- **要件**:
  - レスポンシブデザイン: 320px〜1920px対応
  - タップ領域: 最小44px × 44px（Apple HIG準拠）
  - フォントサイズ: 最小16px（iOS自動ズーム防止）
  - 片手操作: 重要ボタンを画面下部に配置
- **テスト**: iPhone SE (375px)、iPhone 14 Pro Max (430px)、iPad (768px)

#### NFR-004-2: アクセシビリティ
- **要件**:
  - コントラスト比: WCAG AA準拠（4.5:1以上）
  - 色覚対応: 色だけでなくアイコン・ラベルで情報伝達
  - スクリーンリーダー: aria-label、role属性の適切な設定
- **ツール**: axe DevTools、Lighthouse Accessibility Audit

#### NFR-004-3: パフォーマンス体験
- **要件**:
  - FCP (First Contentful Paint): 1.5秒以内
  - LCP (Largest Contentful Paint): 2.5秒以内
  - CLS (Cumulative Layout Shift): 0.1以下
- **測定**: Lighthouse、Web Vitals

### NFR-005: 保守性

#### NFR-005-1: コード品質
- **要件**:
  - TypeScript strict mode有効
  - ESLint: Next.js推奨設定
  - Prettier: コードフォーマット自動化
  - コンポーネント単位設計: 最大300行/ファイル
- **ツール**: Husky (pre-commit hook)

#### NFR-005-2: テスト
- **要件**:
  - 単体テスト: Jest + Testing Library（カバレッジ60%以上）
  - E2Eテスト: Playwright（主要フロー5シナリオ）
  - 負荷テスト: 30名同時接続シミュレーション
- **CI/CD**: Vercel自動デプロイ時にテスト実行

### NFR-006: データ管理

#### NFR-006-1: データ保持期間
- **要件**:
  - アクティブルーム: ゲーム終了まで
  - 中断ルーム: 24時間後自動削除
  - ログデータ: なし（記録しない）
- **根拠**: ユーザーの回答（Q15: no）

#### NFR-006-2: バックアップ
- **要件**:
  - Supabase自動バックアップ（Daily）
  - リストア手順: Supabase Dashboard操作
- **運用**: 手動リストアのみ（自動復旧なし）

---

## 技術スタック

### フロントエンド

| 技術 | バージョン | 選定理由 |
|------|-----------|---------|
| **Next.js** | 14.x (App Router) | - Vercel最適化、React Server Components対応<br>- ファイルベースルーティング、ゼロコンフィグ<br>- Supabase公式サポート |
| **TypeScript** | 5.x | - 型安全性、開発体験向上<br>- strict mode必須 |
| **XState** | 5.x | - フェーズ遷移のステートマシン化<br>- デバッグ・可視化ツール充実<br>- 複雑な状態管理の明示化 |
| **Tailwind CSS** | 3.x | - ユーティリティファースト、高カスタマイズ性<br>- モバイル最適化容易<br>- ビルドサイズ最小化 |
| **Headless UI** | 2.x | - アクセシビリティ標準対応<br>- Tailwindとの統合<br>- カスタマイズ性高い |
| **Zustand** | 4.x（補助） | - XStateと併用、軽量グローバル状態管理<br>- ユーザー情報、ルーム情報の保持 |

**選定根拠**:
- **機能要件**: リアルタイム同期、フェーズ管理の複雑性に対応
- **非機能要件**: モバイル最適化、アクセシビリティ、パフォーマンス
- **コスト**: 全て無料・OSSライブラリ
- **保守性**: Next.js + TypeScriptの豊富なエコシステム

### バックエンド

| 技術 | プラン | 選定理由 |
|------|-------|---------|
| **Supabase** | Free tier → Pro | - PostgreSQL + Realtime + Auth + Edge Functions統合<br>- RLS標準対応（役職秘匿に必須）<br>- 無料枠で30名同時接続可能 |
| **PostgreSQL** | 15.x | - Supabase標準DB<br>- JSONB型でスナップショット保存<br>- トランザクション処理対応 |
| **Supabase Realtime** | - | - ルーム単位チャネル購読<br>- WebSocket自動管理<br>- 低レイテンシ（平均200ms） |
| **Edge Functions** | Deno runtime | - サーバーレス、自動スケーリング<br>- 投票集計、フェーズ遷移の原子処理<br>- グローバルエッジ配信 |

**選定根拠**:
- **機能要件**: リアルタイム同期、役職秘匿（RLS）、タイマー同期
- **非機能要件**: 同時接続30名、レスポンス500ms以内
- **コスト**: Free tier無料、Pro tier $25/月（スケール時）
- **運用**: マネージドサービス、24時間監視不要

### インフラ・デプロイ

| 技術 | プラン | 選定理由 |
|------|-------|---------|
| **Vercel** | Hobby (無料) | - Next.js最適化、自動ビルド<br>- Edge Runtime対応<br>- HTTPS自動提供 |
| **Vercel Analytics** | - | - Web Vitals測定<br>- Runtime Logsでエラー監視 |
| **GitHub** | - | - バージョン管理、CI/CD統合 |

**選定根拠**:
- **機能要件**: HTTPS必須、自動デプロイ
- **非機能要件**: 可用性99.9%、エラー監視
- **コスト**: 全て無料枠内
- **運用**: 自動デプロイ、手動介入不要

### 開発ツール

| 技術 | 用途 |
|------|------|
| **ESLint** | コード品質チェック |
| **Prettier** | コードフォーマット |
| **Husky** | Git pre-commit hook |
| **Jest** | 単体テスト |
| **Testing Library** | コンポーネントテスト |
| **Playwright** | E2Eテスト |
| **@node-rs/argon2** | パスワードハッシュ化 |

---

## 開発ロードマップ

### フェーズ1: 基盤構築（3週間）

**目標**: ルーム管理、認証、リアルタイム通信の基盤完成

#### Week 1: 環境構築・DB設計
- **タスク**:
  - Next.js + TypeScript + Tailwind環境構築
  - Supabaseプロジェクト作成、Local Development環境セットアップ
  - データベーススキーマ作成（全8テーブル）
  - RLSポリシー実装（役職・お題秘匿）
- **成果物**:
  - DB Migration ファイル
  - RLSポリシーテストコード
  - 環境構築ドキュメント

#### Week 2: ルーム管理・認証
- **タスク**:
  - トップページUI実装（部屋を作る/探す）
  - ルーム作成API（合言葉重複チェック、Argon2ハッシュ化）
  - ルーム参加API（存在確認、ニックネーム重複処理）
  - 匿名認証フロー実装
  - ロビー画面実装（参加者一覧、リアルタイム反映）
- **成果物**:
  - `/` (トップページ)
  - `/rooms/[id]/lobby` (ロビー)
  - API Routes: `POST /api/rooms`, `POST /api/rooms/[id]/join`

#### Week 3: Realtime統合・XState設計
- **タスク**:
  - Supabase Realtime購読実装（ルーム単位チャネル）
  - XStateステートマシン設計（全フェーズ遷移）
  - フェーズ遷移ロジック実装
  - 入退室のRealtime反映テスト
- **成果物**:
  - `lib/state-machine.ts` (XState定義)
  - Realtimeサブスクリプション設計書

**フェーズ1完了基準**:
- ✅ ルーム作成・参加が動作
- ✅ ロビーで入退室がリアルタイム反映
- ✅ RLSポリシーが正しく機能（他人の役職が見えない）

---

### フェーズ2: ゲームコア機能（4週間）

**目標**: 役職配布、お題配信、タイマー、投票の全フェーズ実装

#### Week 4: 役職配布・お題配信
- **タスク**:
  - 役職配布Edge Function実装（前回マスター除外ロジック）
  - お題データ投入（Easy 50, Normal 50, Hard 30）
  - お題選択API（難易度フィルタ、重複除外）
  - 役職配布画面UI（カードアニメーション）
  - お題確認画面UI（役職別表示制御）
- **成果物**:
  - `supabase/functions/assign-roles.ts`
  - `supabase/seed.sql` (お題データ)
  - `/rooms/[id]/deal` (役職配布画面)
  - `/rooms/[id]/topic` (お題確認画面)

#### Week 5: タイマー・質問フェーズ
- **タスク**:
  - サーバーepoch基準タイマー実装
  - 質問フェーズUI（5分カウントダウン）
  - マスター正解報告機能
  - 残り時間計算ロジック
  - タイムアウト処理（全員敗北）
- **成果物**:
  - `/rooms/[id]/question` (質問フェーズ画面)
  - API: `POST /api/sessions/[id]/correct`

#### Week 6: 討論・投票フェーズ
- **タスク**:
  - 討論フェーズUI（正解者ハイライト、残り時間表示）
  - 第一投票UI（Yes/Noボタン、大きなタップ領域）
  - 第二投票UI（候補リスト、ラジオボタン）
  - 投票集計Edge Function
  - 決選投票ロジック（最大2回）
- **成果物**:
  - `/rooms/[id]/debate` (討論画面)
  - `/rooms/[id]/vote1` (第一投票画面)
  - `/rooms/[id]/vote2` (第二投票画面)
  - `supabase/functions/tally-votes.ts`

#### Week 7: 結果・次ラウンド
- **タスク**:
  - 結果画面UI（勝敗表示、全役職公開）
  - アニメーション実装（フェードイン）
  - 次ラウンド機能（状態リセット、履歴保持）
  - ロビーに戻る機能
  - 解散機能（ルーム削除）
- **成果物**:
  - `/rooms/[id]/result` (結果画面)
  - API: `POST /api/sessions/[id]/next-round`

**フェーズ2完了基準**:
- ✅ ゲーム全フェーズが動作（役職配布〜結果）
- ✅ タイマーが正確に同期
- ✅ 投票・決選投票が正しく集計

---

### フェーズ3: 運用強化・UX向上（3週間）

**目標**: 中断・再開、再接続、エラーハンドリング、モバイル最適化

#### Week 8: 中断・再開機能
- **タスク**:
  - 中断処理実装（スナップショット保存）
  - 再開処理実装（状態復元、タイマー再計算）
  - メンバーチェックロジック
  - 24時間自動削除Cron Job
- **成果物**:
  - API: `POST /api/rooms/[id]/suspend`, `POST /api/rooms/[id]/resume`
  - `supabase/functions/cleanup-suspended-rooms.ts`

#### Week 9: 再接続・エラーハンドリング
- **タスク**:
  - Realtime再接続ロジック（指数バックオフ）
  - 状態復元ロジック（投票フェーズ判定）
  - エラートースト実装
  - ネットワークエラーハンドリング
  - マスター/インサイダー離脱時の中断処理
- **成果物**:
  - `lib/reconnection.ts` (再接続ロジック)
  - `components/ErrorToast.tsx`

#### Week 10: モバイル最適化・テスト
- **タスク**:
  - レスポンシブデザイン調整（320px〜1920px）
  - タップ領域検証（44px最小）
  - アクセシビリティ監査（Lighthouse）
  - E2Eテスト実装（Playwright、5シナリオ）
  - 負荷テスト（30名同時接続）
- **成果物**:
  - E2Eテストスイート
  - アクセシビリティ監査レポート
  - 負荷テスト結果

**フェーズ3完了基準**:
- ✅ 中断・再開が正常動作
- ✅ ネットワーク切断からの復帰が正常動作
- ✅ モバイルで快適に操作可能
- ✅ Lighthouse Accessibilityスコア90以上

---

### マイルストーン

| フェーズ | 完了予定 | 主要成果物 |
|---------|---------|----------|
| Phase 1 | Week 3 | ルーム管理、Realtime基盤 |
| Phase 2 | Week 7 | 全ゲームフェーズ動作 |
| Phase 3 | Week 10 | 本番リリース可能状態 |

**総開発期間**: 10週間（約2.5ヶ月）

**フェーズ分けの根拠**:
- **Phase 1**: 技術リスク最小化（Realtime通信、RLSの早期検証）
- **Phase 2**: コア価値提供（ゲームプレイ可能状態）
- **Phase 3**: 運用品質向上（安定性、UX）

---

## リスク分析

### 技術的リスク

#### R-TECH-001: Supabase Realtimeのレイテンシ
- **リスク**: リアルタイム通知が500ms以内に届かない可能性
- **影響**: タイマー同期のズレ、投票集計の遅延
- **発生確率**: 中
- **対策**:
  - 事前検証: 開発初期にRealtimeのレイテンシ測定
  - 代替案: 500ms超過が頻発する場合、Socket.ioに切り替え
  - 緩和策: クライアント側でepoch差分計算（サーバー依存減）

#### R-TECH-002: RLSポリシーの複雑性
- **リスク**: RLSポリシーの設計ミスによる役職・お題の漏洩
- **影響**: ゲームバランス崩壊、信頼性低下
- **発生確率**: 中
- **対策**:
  - テスト徹底: RLSポリシー専用のE2Eテスト
  - レビュー: セキュリティ観点での手動レビュー
  - 検証: ブラウザDevToolsでのデータ取得試行

#### R-TECH-003: XStateの学習曲線
- **リスク**: チームのXState習熟に時間がかかる
- **影響**: 開発遅延、バグ増加
- **発生確率**: 低〜中
- **対策**:
  - 事前学習: 公式ドキュメント、サンプルプロジェクト
  - 代替案: Redux Toolkitへの切り替え（複雑性は増すがチーム慣れている場合）
  - 簡素化: 最小限のステートマシン定義から開始

### ビジネス的リスク

#### R-BIZ-001: ユーザー獲得の困難
- **リスク**: 初期ユーザーが集まらない
- **影響**: フィードバック不足、改善サイクル回らず
- **発生確率**: 中
- **対策**:
  - ベータテスト: 友人グループで小規模テスト
  - SNS活用: Twitter、Discord、Redditでの告知
  - 差別化: 他の類似サービスとの比較表作成

#### R-BIZ-002: 著作権リスク
- **リスク**: オリジナルゲームの権利者からの指摘
- **影響**: サービス停止要求、法的対応
- **発生確率**: 低
- **対策**:
  - 差別化: 固有の名称・デザインを避け、抽象的表現
  - 明記: 「非公式ファンプロジェクト」と明示
  - 非商用: 無料サービスとして運用（広告なし）

### 運用的リスク

#### R-OPS-001: スパム・荒らし対策
- **リスク**: 悪意あるユーザーによるルーム乱立、不適切ニックネーム
- **影響**: ユーザー体験低下、DB容量圧迫
- **発生確率**: 中
- **対策**:
  - レート制限: 同一IPから1分に5ルームまで
  - 自動削除: 24時間後のルーム自動削除
  - フィルタリング: ニックネームのNGワードフィルタ

#### R-OPS-002: サーバーコスト超過
- **リスク**: Supabase Free tier制限超過（50,000 MAU、2GB帯域）
- **影響**: サービス停止、追加課金
- **発生確率**: 低（初期30名想定）
- **対策**:
  - モニタリング: Supabase Dashboardで使用量監視
  - アラート: 80%到達でアラート通知
  - 移行計画: Pro tier移行判断基準（100名同時接続）

#### R-OPS-003: バグ・障害対応
- **リスク**: 本番環境でのバグ発生、ユーザー影響
- **影響**: ゲーム中断、データ不整合
- **発生確率**: 中
- **対策**:
  - ロギング: Vercel Runtime Logsで異常検知
  - ロールバック: Vercel Deploymentの即座ロールバック
  - 緊急対応: GitHub Issuesでバグ報告受付

### 法的・コンプライアンスリスク

#### R-COMP-001: 個人情報保護
- **リスク**: ニックネーム等の個人情報漏洩
- **影響**: 信頼性低下、法的リスク
- **発生確率**: 低
- **対策**:
  - 最小化: 個人情報を極力収集しない
  - 暗号化: HTTPS必須、パスワードハッシュ化
  - 削除: 24時間後の自動削除

---

## 追加情報リクエスト

本要件定義は、ブレインストーミングでの22項目の質問への回答に基づき作成されました。
**追加の不明点はありません。実装フェーズに進むことが可能です。**

### 今後の意思決定ポイント（実装中に発生する可能性）

| 項目 | 判断タイミング | 影響度 |
|------|-------------|-------|
| Socket.ioへの切り替え | Phase 1完了時（Realtimeレイテンシ測定後） | 高 |
| Pro tierへの移行 | ユーザー数100名到達時 | 中 |
| PWA対応 | Phase 3完了後 | 低 |
| 効果音実装 | Phase 3完了後 | 低 |

---

## 承認・レビュー

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|-------|------|
| プロダクトオーナー | - | - | - |
| テックリード | - | - | - |
| セキュリティレビュアー | - | - | - |

---

**次のステップ**: 本要件定義書の承認後、Phase 1の開発着手を推奨します。

**成果物一覧**:
- ✅ システム要件定義書（本書）
- ⏳ 技術仕様書（実装時に作成）
- ⏳ データベース設計書（Migration fileで代替）
- ⏳ API仕様書（実装時に作成）

**付録**:
- 既存資料: `docs/インサイダー_オンライン対戦アプリ概要（実装図ベース）.md`
- フローチャート: `docs/20251019_インサイダー実装図一覧.md`
