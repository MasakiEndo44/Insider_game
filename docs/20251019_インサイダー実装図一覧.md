# 📊 インサイダーゲーム ブラウザアプリ 仕様書

完璧です！すべての要件が明確になりました。それでは成果物を作成します。

---

## 1. 全体状態遷移図

```mermaid
stateDiagram-v2
    [*] --> TopPage: アプリ起動
    TopPage --> CreateRoom: 部屋を作る
    TopPage --> JoinRoom: 部屋を探す
    
    CreateRoom --> Lobby: 合言葉設定
    JoinRoom --> Lobby: 合言葉入力
    
    Lobby --> DealRoles: ホストが開始
    Lobby --> Lobby: プレイヤー入退室
    
    DealRoles --> TopicConfirm: 役職配布完了
    TopicConfirm --> QuestionPhase: 全員確認完了
    
    QuestionPhase --> DebatePhase: 正解報告
    QuestionPhase --> AllLose: タイムアウト(5分)
    
    DebatePhase --> Vote1: 討論終了
    
    Vote1 --> Result: 過半数が告発
    Vote1 --> Vote2: 過半数に達せず
    
    Vote2 --> Vote2: 同票(決選投票)
    Vote2 --> Result: 最多得票者決定 or 3回同票
    
    Result --> Lobby: 次ラウンド
    Result --> TopPage: 解散
    
    AllLose --> Result: 全員敗北
    
    state "中断可能" as Suspended {
        Lobby
        DealRoles
        TopicConfirm
        QuestionPhase
        DebatePhase
        Vote1
        Vote2
    }
    
    Suspended --> Lobby: ホストが中断
    Lobby --> Suspended: 対戦を再開
```

---

## 2. 詳細フローチャート

### 2-1. トップページ・ルーム作成/参加フロー

```mermaid
flowchart TD
    Start([アプリ起動]) --> TopPage[トップページ表示]
    
    TopPage --> CreateBtn{部屋を作る}
    TopPage --> JoinBtn{部屋を探す}
    
    CreateBtn --> InputPass1[合言葉入力<br/>3-10文字 日本語可]
    InputPass1 --> ValidatePass1{バリデーション}
    ValidatePass1 -->|文字数不足/超過| InputPass1
    ValidatePass1 -->|OK| CheckDup1{Supabase<br/>重複チェック}
    CheckDup1 -->|既存| Error1[エラー:<br/>既に存在する合言葉]
    Error1 --> InputPass1
    CheckDup1 -->|新規| CreateRoomDB[Databaseに<br/>ルーム作成]
    CreateRoomDB --> InputNick1[ニックネーム入力]
    InputNick1 --> CreateHost[ホストとして<br/>ルーム参加]
    CreateHost --> Lobby[ロビー画面]
    
    JoinBtn --> InputPass2[合言葉入力]
    InputPass2 --> CheckExist{Supabase<br/>ルーム存在確認}
    CheckExist -->|存在しない| Error2[エラー:<br/>部屋が見つかりません]
    Error2 --> InputPass2
    CheckExist -->|存在| InputNick2[ニックネーム入力]
    InputNick2 --> CheckNick{同じ部屋内<br/>重複チェック}
    CheckNick -->|重複| AddSuffix[ニックネームに<br/>-2を付加]
    CheckNick -->|重複なし| JoinPlayer
    AddSuffix --> JoinPlayer[プレイヤーとして<br/>ルーム参加]
    JoinPlayer --> Lobby
```

### 2-2. ロビー・ゲーム開始フロー

```mermaid
flowchart TD
    Lobby[ロビー画面] --> ShowPlayers[参加者一覧表示<br/>ホストにバッジ表示]
    
    ShowPlayers --> WaitAction{アクション待機}
    
    WaitAction -->|新規参加者| AddPlayer[Realtime受信<br/>参加者追加]
    AddPlayer --> ShowPlayers
    
    WaitAction -->|参加者退出| RemovePlayer[Realtime受信<br/>参加者削除]
    RemovePlayer --> ShowPlayers
    
    WaitAction -->|ホスト: 開始ボタン| CheckCount{参加者数<br/>3-15人?}
    CheckCount -->|2人以下| ErrorCount[エラー表示:<br/>3人以上必要]
    ErrorCount --> WaitAction
    CheckCount -->|16人以上| ErrorCount2[エラー表示:<br/>15人以下にしてください]
    ErrorCount2 --> WaitAction
    CheckCount -->|3-15人| SelectDifficulty[難易度選択画面]
    
    SelectDifficulty --> ConfirmStart{ホスト確認}
    ConfirmStart -->|キャンセル| WaitAction
    ConfirmStart -->|OK| StartGame[ゲーム開始イベント<br/>Realtime送信]
    StartGame --> DealRoles[役職配布フェーズ]
    
    WaitAction -->|再開ボタン<br/>表示時| ResumeCheck{中断データ存在?}
    ResumeCheck -->|なし| WaitAction
    ResumeCheck -->|あり| ResumeMember{メンバー<br/>全員参加?}
    ResumeMember -->|不足| ErrorResume[エラー:<br/>全員揃ってから再開]
    ErrorResume --> WaitAction
    ResumeMember -->|全員| Resume[中断フェーズに<br/>復帰]
```

### 2-3. 役職配布フロー

```mermaid
flowchart TD
    DealRoles[役職配布フェーズ] --> GetHistory{前回の履歴取得<br/>Supabase Database}
    
    GetHistory --> CheckPrevMaster{前回マスター<br/>存在?}
    CheckPrevMaster -->|なし| RandomAll[全員からランダム選出]
    CheckPrevMaster -->|あり| ExcludeMaster[前回マスターを除外<br/>残りからランダム選出]
    
    RandomAll --> SelectMaster[マスター1人選出]
    ExcludeMaster --> SelectMaster
    
    SelectMaster --> SelectInsider[残りから<br/>インサイダー1人選出]
    SelectInsider --> SetCitizens[残り全員を<br/>庶民に設定]
    
    SetCitizens --> SaveRoles[役職をDatabase保存<br/>履歴も更新]
    SaveRoles --> SendRoles[各クライアントに<br/>個別送信 via Realtime]
    
    SendRoles --> ShowRole1[マスター:<br/>「あなたはマスターです!」<br/>カード表示]
    SendRoles --> ShowRole2[インサイダー:<br/>「あなたはインサイダーです目」<br/>カード表示]
    SendRoles --> ShowRole3[庶民:<br/>「あなたは庶民です?」<br/>カード表示]
    
    ShowRole1 --> AllConfirm
    ShowRole2 --> AllConfirm
    ShowRole3 --> AllConfirm
    
    AllConfirm{全員確認完了?} -->|未完了| WaitConfirm[待機]
    WaitConfirm --> AllConfirm
    AllConfirm -->|完了| TopicPhase[お題確認フェーズ]
```

### 2-4. お題確認フロー

```mermaid
flowchart TD
    TopicPhase[お題確認フェーズ] --> GetDifficulty[選択された難易度取得]
    
    GetDifficulty --> FilterTopics[難易度に応じた<br/>お題リストをフィルタ]
    FilterTopics --> ExcludeUsed[セッション内使用済み<br/>お題を除外]
    
    ExcludeUsed --> RandomSelect[残りからランダム選択]
    RandomSelect --> SaveTopic[お題をDatabase保存<br/>使用済みに追加]
    
    SaveTopic --> SendMaster[マスターのみに送信<br/>Realtime個別送信]
    SendMaster --> ShowMaster[マスター画面:<br/>お題を常時表示<br/>小さめ固定位置]
    
    SaveTopic --> SendInsider[インサイダーのみに送信<br/>Realtime個別送信]
    SendInsider --> ShowInsider[インサイダー画面:<br/>お題ポップアップ<br/>10秒間表示]
    
    SaveTopic --> SendOthers[庶民には送信しない]
    SendOthers --> ShowCitizen[庶民画面:<br/>「お題を確認中...」]
    
    ShowMaster --> WaitAll
    ShowInsider --> WaitAll
    ShowCitizen --> WaitAll
    
    WaitAll{全員確認完了?} -->|未完了| WaitAll
    WaitAll -->|完了| QuestionPhase[質問フェーズ]
```

### 2-5. 質問フェーズフロー

```mermaid
flowchart TD
    QuestionPhase[質問フェーズ開始] --> CalcDeadline[開始時刻 + 5分<br/>= 締切epoch計算]
    
    CalcDeadline --> SaveDeadline[締切をDatabase保存]
    SaveDeadline --> BroadcastStart[全クライアントに<br/>フェーズ開始通知<br/>+ 締切epoch送信]
    
    BroadcastStart --> ShowTimer[各クライアント:<br/>残り時間表示<br/>epoch差分で計算]
    ShowTimer --> ShowTurn[発言順表示<br/>1人ずつ質問]
    
    ShowTurn --> WaitAction{アクション待機}
    
    WaitAction -->|マスター: 正解報告| CheckTime{サーバー時刻<br/>≤ 締切?}
    CheckTime -->|時間超過| IgnoreCorrect[報告を無視]
    IgnoreCorrect --> WaitAction
    CheckTime -->|時間内| RecordCorrect[正解者を記録<br/>Database保存]
    RecordCorrect --> CalcElapsed[経過時間計算:<br/>開始〜正解報告]
    CalcElapsed --> CalcDebate[討論時間 =<br/>5分 - 経過時間]
    CalcDebate --> DebatePhase[討論フェーズへ]
    
    WaitAction -->|タイマー: 0秒| Timeout[タイムアウト]
    Timeout --> SetAllLose[結果: 全員敗北<br/>Database保存]
    SetAllLose --> Result[結果画面]
    
    WaitAction -->|ホスト: 中断| Suspend[中断処理]
    WaitAction -->|プレイヤー離脱| HandleLeave[離脱処理]
    HandleLeave -->|正解者| DebatePhase
    HandleLeave -->|それ以外| WaitAction
```

### 2-6. 討論フェーズフロー

```mermaid
flowchart TD
    DebatePhase[討論フェーズ開始] --> GetRemain[残り時間を取得<br/>質問フェーズから引継ぎ]
    
    GetRemain --> CalcDeadline2[現在時刻 + 残り時間<br/>= 締切epoch計算]
    CalcDeadline2 --> SaveDeadline2[締切をDatabase保存]
    SaveDeadline2 --> BroadcastDebate[全クライアントに通知<br/>正解者ハイライト<br/>+ 締切epoch]
    
    BroadcastDebate --> ShowTimer2[残り時間表示]
    ShowTimer2 --> ShowCorrector[正解者を強調表示]
    ShowCorrector --> Discussion[自由討論<br/>アプリは介入しない]
    
    Discussion --> WaitEnd{終了待機}
    
    WaitEnd -->|タイマー: 0秒| AutoEnd[自動終了]
    WaitEnd -->|ホスト: 討論終了| ManualEnd[手動終了]
    
    AutoEnd --> Vote1Phase[第一投票フェーズ]
    ManualEnd --> Vote1Phase
    
    WaitEnd -->|ホスト: 中断| Suspend2[中断処理]
    WaitEnd -->|プレイヤー離脱| HandleLeave2[離脱処理<br/>討論続行]
    HandleLeave2 --> WaitEnd
```

### 2-7. 第一投票フロー

```mermaid
flowchart TD
    Vote1Phase[第一投票フェーズ] --> ShowQuestion[画面表示:<br/>「正解者をインサイダーとして<br/>告発しますか?」]
    
    ShowQuestion --> ShowButtons[Yes/Noボタン表示<br/>大きなタップ領域]
    ShowButtons --> WaitVotes{投票待機}
    
    WaitVotes -->|プレイヤー: 投票| RecordVote1[投票をDatabase記録<br/>個別テーブル]
    RecordVote1 --> CheckComplete1{全員投票完了?}
    
    CheckComplete1 -->|未完了| WaitVotes
    CheckComplete1 -->|完了| CountVotes1[集計処理]
    
    CountVotes1 --> CalcMajority{Yes票が過半数?<br/>|中央値|票以上}
    
    CalcMajority -->|Yes過半数| RevealCorrector[正解者の役職を公開]
    RevealCorrector --> CheckInsider{インサイダー?}
    CheckInsider -->|Yes| CitizenWin[勝敗: 庶民勝利]
    CheckInsider -->|No| InsiderWin1[勝敗: インサイダー勝利]
    CitizenWin --> Result1[結果画面]
    InsiderWin1 --> Result1
    
    CalcMajority -->|No過半数| Vote2Phase[第二投票フェーズ]
    
    WaitVotes -->|ホスト: 中断| Suspend3[中断処理]
    WaitVotes -->|プレイヤー離脱| InvalidVote[その人の票を無効化<br/>離脱者除外して再集計]
    InvalidVote --> CheckComplete1
```

### 2-8. 第二投票フロー（決選投票含む）

```mermaid
flowchart TD
    Vote2Phase[第二投票フェーズ] --> ExcludePlayers[候補者リスト作成:<br/>マスター・正解者を除外]
    
    ExcludePlayers --> ShowCandidates[候補者一覧表示<br/>ラジオボタン選択式]
    ShowCandidates --> WaitVotes2{投票待機}
    
    WaitVotes2 -->|プレイヤー: 投票| RecordVote2[投票をDatabase記録]
    RecordVote2 --> CheckComplete2{全員投票完了?}
    CheckComplete2 -->|未完了| WaitVotes2
    
    CheckComplete2 -->|完了| CountVotes2[集計処理]
    CountVotes2 --> FindMax{最多得票者<br/>特定?}
    
    FindMax -->|1人のみ| RevealVoted[最多得票者の<br/>役職を公開]
    RevealVoted --> CheckInsider2{インサイダー?}
    CheckInsider2 -->|Yes| CitizenWin2[勝敗: 庶民勝利]
    CheckInsider2 -->|No| InsiderWin2[勝敗: インサイダー勝利]
    
    FindMax -->|同票複数| CheckRound{決選投票<br/>回数?}
    CheckRound -->|1回目| RunoffVote1[決選投票<br/>同票者のみで再投票]
    CheckRound -->|2回目| RunoffVote2[決選投票<br/>同票者のみで再投票]
    CheckRound -->|3回目| InsiderEscape[3回同票<br/>インサイダー逃げ切り勝利]
    
    RunoffVote1 --> CountVotes2
    RunoffVote2 --> CountVotes2
    
    CitizenWin2 --> Result2[結果画面]
    InsiderWin2 --> Result2
    InsiderEscape --> Result2
    
    WaitVotes2 -->|ホスト: 再投票| CheckRetry{再投票権<br/>残っている?}
    CheckRetry -->|使用済み| IgnoreRetry[無視]
    IgnoreRetry --> WaitVotes2
    CheckRetry -->|未使用| ResetVotes[投票をリセット<br/>再投票権消費]
    ResetVotes --> ShowCandidates
    
    WaitVotes2 -->|プレイヤー離脱| InvalidVote2[その人の票を無効化]
    InvalidVote2 --> CheckComplete2
```

### 2-9. 結果表示・次ラウンドフロー

```mermaid
flowchart TD
    Result[結果画面] --> ShowOutcome[勝敗表示<br/>「庶民勝利!」など]
    
    ShowOutcome --> RevealRoles[全員の役職公開<br/>マスター!/インサイダー目/庶民?]
    RevealRoles --> ShowStats[任意: スコア表示<br/>各陣営の累計勝利数]
    
    ShowStats --> HostAction{ホストアクション}
    
    HostAction -->|次ラウンド| CheckMembers{参加者変動?}
    CheckMembers -->|同じ| ResetGame[ゲーム状態リセット<br/>役職履歴のみ保持]
    CheckMembers -->|変動あり| ConfirmContinue[確認ダイアログ:<br/>メンバー変更あり]
    ConfirmContinue -->|OK| ResetGame
    ConfirmContinue -->|キャンセル| HostAction
    
    ResetGame --> DealRoles[役職配布フェーズ]
    
    HostAction -->|ロビーに戻る| BackLobby[ロビー画面<br/>参加者維持]
    
    HostAction -->|解散| ConfirmDisband{解散確認<br/>ダイアログ}
    ConfirmDisband -->|キャンセル| HostAction
    ConfirmDisband -->|OK| DeleteRoom[Databaseから<br/>ルーム削除]
    DeleteRoom --> NotifyAll[全員に通知<br/>Realtime]
    NotifyAll --> TopPage[各自トップページへ]
```

### 2-10. 中断・再開フロー

```mermaid
flowchart TD
    AnyPhase[任意のフェーズ] --> HostSuspend{ホスト:<br/>中断ボタン}
    
    HostSuspend -->|押下| ConfirmSuspend{確認ダイアログ}
    ConfirmSuspend -->|キャンセル| AnyPhase
    ConfirmSuspend -->|OK| SaveState[現在の状態を<br/>Database保存<br/>フェーズ/タイマー/投票状況]
    
    SaveState --> NotifySuspend[全員に中断通知<br/>Realtime]
    NotifySuspend --> ReturnLobby[全員ロビーに移動<br/>「対戦を再開」ボタン表示]
    
    ReturnLobby --> WaitResume{待機}
    
    WaitResume -->|参加者増減| UpdateMembers[参加者リスト更新<br/>再開不可状態維持]
    UpdateMembers --> WaitResume
    
    WaitResume -->|ホスト: 再開ボタン| CheckResumeMembers{中断時の<br/>メンバー全員?}
    CheckResumeMembers -->|不足| ErrorResume2[エラー表示:<br/>全員揃っていません]
    ErrorResume2 --> WaitResume
    
    CheckResumeMembers -->|全員| LoadState[保存状態を読込<br/>Database]
    LoadState --> RestorePhase[該当フェーズに遷移]
    RestorePhase --> RestoreTimer{タイマー<br/>残っていた?}
    
    RestoreTimer -->|Yes| RecalcDeadline[残り時間を再計算<br/>現在時刻 + 残り秒数]
    RestoreTimer -->|No| RestoreVote[投票状態を復元]
    
    RecalcDeadline --> NotifyResume[全員に再開通知<br/>+ 新締切epoch]
    RestoreVote --> NotifyResume
    NotifyResume --> ResumedPhase[該当フェーズ続行]
```

---

## 3. シーケンス図

### 3-1. 部屋作成・参加シーケンス

```mermaid
sequenceDiagram
    participant C1 as クライアント1<br/>(ホスト)
    participant C2 as クライアント2<br/>(参加者)
    participant SB as Supabase<br/>(Realtime + DB)
    
    Note over C1: 部屋を作る
    C1->>C1: 合言葉入力(3-10文字)
    C1->>SB: 重複チェッククエリ
    SB-->>C1: 重複なし
    C1->>SB: rooms テーブルに<br/>INSERT (passphrase, host_id)
    SB-->>C1: ルームID返却
    C1->>C1: ニックネーム入力
    C1->>SB: players テーブルに<br/>INSERT (room_id, nickname, is_host=true)
    SB-->>C1: プレイヤーID返却
    C1->>SB: Realtime購読開始<br/>room:{roomId}
    SB-->>C1: 購読確立
    C1->>C1: ロビー画面表示
    
    Note over C2: 部屋を探す
    C2->>C2: 合言葉入力
    C2->>SB: 存在確認クエリ<br/>WHERE passphrase = ?
    SB-->>C2: ルームID返却
    C2->>C2: ニックネーム入力
    C2->>SB: 重複チェッククエリ<br/>WHERE room_id = ? AND nickname = ?
    SB-->>C2: 重複あり
    C2->>C2: ニックネームに-2付加
    C2->>SB: players テーブルに<br/>INSERT
    SB-->>C2: プレイヤーID返却
    C2->>SB: Realtime購読開始<br/>room:{roomId}
    SB-->>C2: 購読確立
    
    SB->>C1: Realtime通知<br/>players INSERT
    C1->>C1: 参加者リスト更新
    SB->>C2: Realtime通知<br/>全参加者データ
    C2->>C2: ロビー画面表示
```

### 3-2. ゲーム開始・役職配布シーケンス

```mermaid
sequenceDiagram
    participant H as ホスト<br/>クライアント
    participant P as 参加者<br/>クライアント
    participant SB as Supabase<br/>(Realtime + DB)
    
    H->>H: 開始ボタン押下
    H->>SB: 人数チェッククエリ
    SB-->>H: 3-15人確認
    H->>H: 難易度選択(Easy/Normal/Hard)
    H->>SB: game_sessions テーブルに<br/>INSERT (room_id, difficulty)
    SB-->>H: セッションID返却
    
    H->>SB: 前回の役職履歴取得<br/>SELECT prev_master FROM sessions
    SB-->>H: 前回マスターID返却
    
    H->>H: 役職配布ロジック実行<br/>前回マスター除外してランダム
    H->>SB: roles テーブルに<br/>INSERT (session_id, player_id, role)
    SB-->>H: 登録完了
    
    H->>SB: phase更新<br/>UPDATE rooms SET phase='DEAL'
    SB->>H: Realtime通知<br/>phase変更
    SB->>P: Realtime通知<br/>phase変更
    
    H->>H: 役職配布画面遷移
    P->>P: 役職配布画面遷移
    
    SB->>H: Realtime通知<br/>roles INSERT (自分の役職のみ)
    SB->>P: Realtime通知<br/>roles INSERT (自分の役職のみ)
    
    H->>H: 役職カード表示<br/>「あなたは庶民です?」
    P->>P: 役職カード表示<br/>「あなたはマスターです!」
    
    H->>SB: 確認完了通知<br/>UPDATE players SET confirmed=true
    P->>SB: 確認完了通知<br/>UPDATE players SET confirmed=true
    
    SB->>H: Realtime通知<br/>confirmed更新
    SB->>P: Realtime通知<br/>confirmed更新
    
    Note over SB: 全員confirmed=true確認
    SB->>H: Realtime通知<br/>phase='TOPIC'
    SB->>P: Realtime通知<br/>phase='TOPIC'
```

### 3-3. お題確認シーケンス

```mermaid
sequenceDiagram
    participant M as マスター
    participant I as インサイダー
    participant C as 庶民
    participant SB as Supabase
    
    Note over SB: phase='TOPIC'移行後
    
    SB->>SB: 難易度に応じたお題フィルタ
    SB->>SB: セッション内使用済み除外
    SB->>SB: ランダム選択
    SB->>SB: topics テーブルに<br/>INSERT (session_id, topic_text)
    SB->>SB: used_topics に追加
    
    SB->>M: Realtime通知<br/>topics INSERT (自分だけ)
    M->>M: お題を常時表示<br/>画面上部に固定
    M->>SB: 確認完了通知<br/>confirmed=true
    
    SB->>I: Realtime通知<br/>topics INSERT (自分だけ)
    I->>I: お題ポップアップ表示<br/>10秒間
    I->>I: 10秒後自動消去
    I->>SB: 確認完了通知<br/>confirmed=true
    
    C->>C: 「お題を確認中...」表示
    C->>SB: 確認完了通知<br/>confirmed=true
    
    Note over SB: 全員confirmed=true確認
    SB->>M: Realtime通知<br/>phase='QUESTION'<br/>+ deadline_epoch
    SB->>I: Realtime通知<br/>phase='QUESTION'<br/>+ deadline_epoch
    SB->>C: Realtime通知<br/>phase='QUESTION'<br/>+ deadline_epoch
```

### 3-4. 質問フェーズシーケンス

```mermaid
sequenceDiagram
    participant M as マスター
    participant P as プレイヤー
    participant SB as Supabase
    participant T as タイマー監視<br/>(サーバー側)
    
    Note over SB: phase='QUESTION'移行
    SB->>SB: 開始時刻記録<br/>start_time = now()
    SB->>SB: 締切計算<br/>deadline = now() + 5min
    SB->>SB: UPDATE sessions<br/>SET phase='QUESTION', deadline
    
    SB->>M: Realtime通知<br/>deadline_epoch
    SB->>P: Realtime通知<br/>deadline_epoch
    
    M->>M: 残り時間表示開始<br/>ローカル計算
    P->>P: 残り時間表示開始<br/>ローカル計算
    
    loop 質問・回答
        P->>M: 口頭で質問<br/>(Discord等)
        M->>P: 口頭で回答<br/>(Discord等)
    end
    
    Note over M: 正解が出た
    M->>SB: 正解報告<br/>POST /correct<br/>{ answerer_id }
    
    SB->>SB: サーバー時刻チェック<br/>now() <= deadline ?
    
    alt 時間内
        SB->>SB: 経過時間計算<br/>elapsed = now() - start_time
        SB->>SB: 討論時間計算<br/>debate_time = 5min - elapsed
        SB->>SB: UPDATE sessions<br/>SET phase='DEBATE',<br/>answerer_id,<br/>deadline = now() + debate_time
        
        SB->>M: Realtime通知<br/>phase='DEBATE'<br/>+ 新deadline_epoch
        SB->>P: Realtime通知<br/>phase='DEBATE'<br/>+ 新deadline_epoch<br/>+ answerer_id
        
        M->>M: 討論画面遷移
        P->>P: 討論画面遷移<br/>正解者ハイライト
    else 時間超過
        SB-->>M: エラー応答<br/>「時間切れ」
    end
    
    T->>T: deadline到達監視
    alt タイムアウト
        T->>SB: UPDATE sessions<br/>SET phase='RESULT',<br/>outcome='ALL_LOSE'
        SB->>M: Realtime通知<br/>phase='RESULT'<br/>outcome='ALL_LOSE'
        SB->>P: Realtime通知<br/>phase='RESULT'<br/>outcome='ALL_LOSE'
    end
```

### 3-5. 投票フェーズシーケンス（第一・第二投票）

```mermaid
sequenceDiagram
    participant P1 as プレイヤー1
    participant P2 as プレイヤー2
    participant SB as Supabase
    
    Note over SB: phase='DEBATE'終了
    SB->>SB: UPDATE sessions<br/>SET phase='VOTE1'
    SB->>P1: Realtime通知<br/>phase='VOTE1'
    SB->>P2: Realtime通知<br/>phase='VOTE1'
    
    P1->>P1: 「正解者をインサイダーとして<br/>告発しますか?」表示
    P2->>P2: 同じ画面表示
    
    P1->>SB: 投票<br/>POST /vote1<br/>{ vote: 'yes' }
    SB->>SB: votes テーブルに<br/>INSERT (session_id, player_id, vote)
    SB->>P1: Realtime通知<br/>投票済みステータス
    SB->>P2: Realtime通知<br/>「P1投票完了」
    
    P2->>SB: 投票<br/>POST /vote1<br/>{ vote: 'no' }
    SB->>SB: INSERT votes
    
    Note over SB: 全員投票完了検出
    SB->>SB: 集計処理<br/>COUNT(vote='yes')
    SB->>SB: 過半数判定<br/>yes_count > total/2 ?
    
    alt Yes過半数
        SB->>SB: 正解者の役職取得
        SB->>SB: UPDATE sessions<br/>SET phase='RESULT',<br/>revealed_player_id
        
        SB->>P1: Realtime通知<br/>phase='RESULT'<br/>+ 正解者役職公開<br/>+ 勝敗
        SB->>P2: Realtime通知<br/>同上
        
    else No過半数
        SB->>SB: UPDATE sessions<br/>SET phase='VOTE2'
        SB->>SB: 候補者リスト生成<br/>(マスター・正解者除外)
        
        SB->>P1: Realtime通知<br/>phase='VOTE2'<br/>+ 候補者リスト
        SB->>P2: Realtime通知<br/>同上
        
        P1->>P1: 候補者一覧表示
        P2->>P2: 同じ画面表示
        
        P1->>SB: 投票<br/>POST /vote2<br/>{ candidate_id }
        P2->>SB: 投票<br/>POST /vote2<br/>{ candidate_id }
        
        Note over SB: 全員投票完了検出
        SB->>SB: 集計処理<br/>各候補の得票数計算
        SB->>SB: 最多得票者判定
        
        alt 最多1人
            SB->>SB: その人の役職取得
            SB->>SB: UPDATE sessions<br/>SET phase='RESULT'
            SB->>P1: Realtime通知<br/>結果 + 役職公開
            SB->>P2: Realtime通知<br/>同上
            
        else 同票複数
            SB->>SB: UPDATE sessions<br/>SET phase='VOTE2_RUNOFF',<br/>runoff_round++
            SB->>SB: 同票者のみリスト化
            
            alt 3回目同票
                SB->>SB: UPDATE sessions<br/>SET phase='RESULT',<br/>outcome='INSIDER_WIN'
                SB->>P1: Realtime通知<br/>「インサイダー逃げ切り」
                SB->>P2: Realtime通知<br/>同上
            else 1-2回目
                SB->>P1: Realtime通知<br/>「決選投票」<br/>+ 同票者リスト
                SB->>P2: Realtime通知<br/>同上
                Note over P1,P2: 決選投票へ<br/>(同じフロー)
            end
        end
    end
```

### 3-6. 再投票シーケンス

```mermaid
sequenceDiagram
    participant H as ホスト
    participant P as プレイヤー
    participant SB as Supabase
    
    Note over SB: 第二投票完了後
    SB->>H: Realtime通知<br/>投票結果表示
    SB->>P: Realtime通知<br/>投票結果表示
    
    H->>H: 「再投票」ボタン表示<br/>(1回のみ可能)
    H->>SB: 再投票リクエスト<br/>POST /revote
    
    SB->>SB: 再投票権チェック<br/>retry_used = false ?
    
    alt 未使用
        SB->>SB: UPDATE sessions<br/>SET retry_used=true
        SB->>SB: DELETE FROM votes<br/>WHERE session_id AND round=current
        SB->>SB: 候補者リスト再生成<br/>(同じ候補)
        
        SB->>H: Realtime通知<br/>「再投票開始」<br/>+ 候補者リスト
        SB->>P: Realtime通知<br/>同上
        
        H->>H: 投票画面再表示<br/>前回の選択はリセット
        P->>P: 同じ画面
        
        Note over H,P: 投票プロセス再開<br/>(通常の第二投票と同じ)
        
    else 使用済み
        SB-->>H: エラー応答<br/>「再投票権使用済み」
        H->>H: エラー表示<br/>無視
    end
```

### 3-7. 中断・再開シーケンス

```mermaid
sequenceDiagram
    participant H as ホスト
    participant P as プレイヤー
    participant SB as Supabase
    
    Note over H: 任意のフェーズで
    H->>H: 中断ボタン押下
    H->>H: 確認ダイアログ表示
    H->>SB: 中断リクエスト<br/>POST /suspend
    
    SB->>SB: 現在状態をスナップショット保存<br/>suspended_state JSON:<br/>{ phase, timer_remaining,<br/>  votes, answerer_id, ... }
    SB->>SB: UPDATE rooms<br/>SET phase='LOBBY',<br/>is_suspended=true
    
    SB->>H: Realtime通知<br/>phase='LOBBY'<br/>+ suspend_flag
    SB->>P: Realtime通知<br/>同上
    
    H->>H: ロビー画面遷移<br/>「対戦を再開」ボタン表示
    P->>P: 同じ画面遷移
    
    Note over H: しばらく後...
    H->>H: 「対戦を再開」押下
    H->>SB: 再開可否チェック<br/>GET /can_resume
    
    SB->>SB: 中断時メンバーと<br/>現在メンバー比較
    
    alt 全員揃っている
        SB-->>H: 再開可能
        H->>SB: 再開リクエスト<br/>POST /resume
        
        SB->>SB: suspended_state読込
        SB->>SB: 残り時間再計算<br/>new_deadline = now() + remaining
        SB->>SB: UPDATE rooms<br/>SET phase=保存phase,<br/>is_suspended=false
        
        SB->>H: Realtime通知<br/>phase復元<br/>+ 新deadline<br/>+ 全状態データ
        SB->>P: Realtime通知<br/>同上
        
        H->>H: 中断時のフェーズ画面に遷移<br/>タイマー再開
        P->>P: 同じ画面遷移
        
    else メンバー不足
        SB-->>H: 再開不可<br/>{ missing_players: [...] }
        H->>H: エラー表示<br/>「〇〇さんが不在です」
    end
```

### 3-8. 離脱・再接続シーケンス

```mermaid
sequenceDiagram
    participant P as プレイヤー
    participant SB as Supabase
    participant O as 他プレイヤー
    
    Note over P: ネットワーク切断
    P->>P: 接続断検知
    P->>P: 「再接続中...」表示
    
    SB->>SB: Heartbeat timeout検出
    SB->>SB: UPDATE players<br/>SET is_connected=false
    
    SB->>O: Realtime通知<br/>「Pさん切断」
    O->>O: プレイヤーリストに<br/>グレーアウト表示
    
    Note over P: ネットワーク復旧
    P->>SB: 再接続リクエスト<br/>GET /reconnect<br/>{ player_id, room_id }
    
    SB->>SB: セッション検証
    SB->>SB: 現在フェーズ取得
    SB-->>P: 再接続OK<br/>+ 現在状態データ
    
    P->>SB: Realtime再購読<br/>room:{roomId}
    SB-->>P: 購読確立
    
    SB->>SB: UPDATE players<br/>SET is_connected=true
    SB->>O: Realtime通知<br/>「Pさん再接続」
    O->>O: プレイヤーリスト復元
    
    P->>P: 現在フェーズに遷移
    
    alt 投票フェーズ中
        P->>P: 未投票なら投票画面表示
        P->>P: 投票済みなら結果待ち画面
    else タイマーフェーズ中
        P->>P: 残り時間再計算して表示
    else 結果フェーズ
        P->>P: 結果画面表示
    end
```

---

## 4. データベーススキーマ（補足）

### 4-1. 主要テーブル

```sql
-- ルーム
CREATE TABLE rooms (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  passphrase TEXT NOT NULL UNIQUE, -- 合言葉（3-10文字）
  host_id UUID REFERENCES players(id),
  phase TEXT NOT NULL DEFAULT 'LOBBY', -- LOBBY/DEAL/TOPIC/QUESTION/DEBATE/VOTE1/VOTE2/RESULT
  is_suspended BOOLEAN DEFAULT false,
  suspended_state JSONB, -- 中断時の状態スナップショット
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- プレイヤー
CREATE TABLE players (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  room_id UUID REFERENCES rooms(id) ON DELETE CASCADE,
  nickname TEXT NOT NULL,
  is_host BOOLEAN DEFAULT false,
  is_connected BOOLEAN DEFAULT true,
  confirmed BOOLEAN DEFAULT false, -- フェーズ確認フラグ
  created_at TIMESTAMP DEFAULT now()
);

-- ゲームセッション（ラウンド単位）
CREATE TABLE game_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  room_id UUID REFERENCES rooms(id) ON DELETE CASCADE,
  difficulty TEXT NOT NULL, -- Easy/Normal/Hard
  start_time TIMESTAMP,
  deadline_epoch BIGINT, -- タイマー締切（epoch秒）
  answerer_id UUID REFERENCES players(id), -- 正解者
  phase TEXT NOT NULL,
  prev_master_id UUID REFERENCES players(id), -- 前回のマスター
  created_at TIMESTAMP DEFAULT now()
);

-- 役職
CREATE TABLE roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID REFERENCES game_sessions(id) ON DELETE CASCADE,
  player_id UUID REFERENCES players(id) ON DELETE CASCADE,
  role TEXT NOT NULL, -- MASTER/INSIDER/CITIZEN
  created_at TIMESTAMP DEFAULT now(),
  UNIQUE(session_id, player_id)
);

-- お題
CREATE TABLE topics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID REFERENCES game_sessions(id) ON DELETE CASCADE,
  topic_text TEXT NOT NULL,
  difficulty TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT now()
);

-- 使用済みお題（セッション内重複回避）
CREATE TABLE used_topics (
  session_id UUID REFERENCES game_sessions(id) ON DELETE CASCADE,
  topic_id UUID,
  PRIMARY KEY(session_id, topic_id)
);

-- 投票
CREATE TABLE votes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID REFERENCES game_sessions(id) ON DELETE CASCADE,
  player_id UUID REFERENCES players(id) ON DELETE CASCADE,
  vote_type TEXT NOT NULL, -- VOTE1/VOTE2/RUNOFF
  vote_value TEXT, -- VOTE1: yes/no, VOTE2: candidate_id
  round INT DEFAULT 1, -- 決選投票の回数
  created_at TIMESTAMP DEFAULT now()
);

-- 結果
CREATE TABLE results (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID REFERENCES game_sessions(id) ON DELETE CASCADE,
  outcome TEXT NOT NULL, -- CITIZENS_WIN/INSIDER_WIN/ALL_LOSE
  revealed_player_id UUID REFERENCES players(id), -- 公開された人
  created_at TIMESTAMP DEFAULT now()
);
```

---

## 5. 実装チェックリスト

### フロントエンド（React）

- [ ] トップページ（部屋作成/検索UI）
- [ ] ロビー画面（参加者リスト、開始ボタン、再開ボタン）
- [ ] 役職配布画面（カード表示、アニメーション）
- [ ] お題確認画面（役職別の表示制御）
- [ ] 質問フェーズ画面（タイマー表示、正解報告ボタン）
- [ ] 討論フェーズ画面（正解者ハイライト、残り時間）
- [ ] 第一投票画面（Yes/Noボタン、集計表示）
- [ ] 第二投票画面（候補者リスト、決選投票UI）
- [ ] 結果画面（勝敗、全役職公開、次ラウンド/解散）
- [ ] 中断・再開UI（確認ダイアログ、状態復元）
- [ ] エラーハンドリング（トースト通知、再接続表示）
- [ ] レスポンシブ対応（PC/スマホ）
- [ ] アクセシビリティ（フォントサイズ、タップ領域、色覚対応）

### バックエンド（Supabase）

- [ ] Databaseスキーマ作成
- [ ] Realtime設定（room単位の購読）
- [ ] RPC関数実装（役職配布、集計処理、状態遷移）
- [ ] Row Level Security設定（役職情報の秘匿）
- [ ] Webhooks/Edge Functions（タイマー監視、自動遷移）
- [ ] お題データ投入（JSON→Database）
- [ ] 再接続ロジック
- [ ] 中断・再開ロジック
- [ ] 投票集計・同票処理
- [ ] ログ記録（監査用）

### テスト

- [ ] 役職配布の偏りテスト（100回実行して統計）
- [ ] 同時正解の排他制御テスト
- [ ] タイマー境界値テスト（0秒、1秒前）
- [ ] 同票・決選投票の全パターン
- [ ] 離脱・再接続の全フェーズ
- [ ] 中断・再開の状態復元
- [ ] 再投票権の1回制限
- [ ] 合言葉重複チェック
- [ ] ニックネーム重複時の-2付加
- [ ] 負荷テスト（30名同時接続）

---

## 6. 補足事項

### タイマー同期の実装例（React側）

```typescript
// クライアント側でのタイマー表示
useEffect(() => {
  if (!deadlineEpoch) return;
  
  const interval = setInterval(() => {
    const now = Math.floor(Date.now() / 1000);
    const remaining = deadlineEpoch - now;
    
    if (remaining <= 0) {
      setTimeRemaining(0);
      clearInterval(interval);
      // タイムアウト処理はサーバー側で実施
    } else {
      setTimeRemaining(remaining);
    }
  }, 100); // 0.1秒ごとに更新
  
  return () => clearInterval(interval);
}, [deadlineEpoch]);
```

### Supabase Realtime購読例

```typescript
const channel = supabase.channel(`room:${roomId}`)
  .on('postgres_changes', 
    { event: 'UPDATE', schema: 'public', table: 'rooms' },
    (payload) => {
      // フェーズ変更を検知
      if (payload.new.phase !== currentPhase) {
        setCurrentPhase(payload.new.phase);
      }
    }
  )
  .on('postgres_changes',
    { event: 'INSERT', schema: 'public', table: 'players', filter: `room_id=eq.${roomId}` },
    (payload) => {
      // 新規参加者を追加
      setPlayers(prev => [...prev, payload.new]);
    }
  )
  .subscribe();
```

---

以上が「インサイダーゲーム オンライン版」の完全な仕様書となります。 不明点や追加で詳細化が必要な箇所があればお知らせください！