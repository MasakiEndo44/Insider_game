# ğŸ“Š ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼ã‚²ãƒ¼ãƒ  ãƒ–ãƒ©ã‚¦ã‚¶ã‚¢ãƒ—ãƒª ä»•æ§˜æ›¸

å®Œç’§ã§ã™ï¼ã™ã¹ã¦ã®è¦ä»¶ãŒæ˜ç¢ºã«ãªã‚Šã¾ã—ãŸã€‚ãã‚Œã§ã¯æˆæœç‰©ã‚’ä½œæˆã—ã¾ã™ã€‚

---

## 1. å…¨ä½“çŠ¶æ…‹é·ç§»å›³

```mermaid
stateDiagram-v2
    [*] --> TopPage: ã‚¢ãƒ—ãƒªèµ·å‹•
    TopPage --> CreateRoom: éƒ¨å±‹ã‚’ä½œã‚‹
    TopPage --> JoinRoom: éƒ¨å±‹ã‚’æ¢ã™
    
    CreateRoom --> Lobby: åˆè¨€è‘‰è¨­å®š
    JoinRoom --> Lobby: åˆè¨€è‘‰å…¥åŠ›
    
    Lobby --> DealRoles: ãƒ›ã‚¹ãƒˆãŒé–‹å§‹
    Lobby --> Lobby: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…¥é€€å®¤
    
    DealRoles --> TopicConfirm: å½¹è·é…å¸ƒå®Œäº†
    TopicConfirm --> QuestionPhase: å…¨å“¡ç¢ºèªå®Œäº†
    
    QuestionPhase --> DebatePhase: æ­£è§£å ±å‘Š
    QuestionPhase --> AllLose: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ(5åˆ†)
    
    DebatePhase --> Vote1: è¨è«–çµ‚äº†
    
    Vote1 --> Result: éåŠæ•°ãŒå‘Šç™º
    Vote1 --> Vote2: éåŠæ•°ã«é”ã›ãš
    
    Vote2 --> Vote2: åŒç¥¨(æ±ºé¸æŠ•ç¥¨)
    Vote2 --> Result: æœ€å¤šå¾—ç¥¨è€…æ±ºå®š or 3å›åŒç¥¨
    
    Result --> Lobby: æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰
    Result --> TopPage: è§£æ•£
    
    AllLose --> Result: å…¨å“¡æ•—åŒ—
    
    state "ä¸­æ–­å¯èƒ½" as Suspended {
        Lobby
        DealRoles
        TopicConfirm
        QuestionPhase
        DebatePhase
        Vote1
        Vote2
    }
    
    Suspended --> Lobby: ãƒ›ã‚¹ãƒˆãŒä¸­æ–­
    Lobby --> Suspended: å¯¾æˆ¦ã‚’å†é–‹
```

---

## 2. è©³ç´°ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ

### 2-1. ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ãƒ»ãƒ«ãƒ¼ãƒ ä½œæˆ/å‚åŠ ãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TD
    Start([ã‚¢ãƒ—ãƒªèµ·å‹•]) --> TopPage[ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸è¡¨ç¤º]
    
    TopPage --> CreateBtn{éƒ¨å±‹ã‚’ä½œã‚‹}
    TopPage --> JoinBtn{éƒ¨å±‹ã‚’æ¢ã™}
    
    CreateBtn --> InputPass1[åˆè¨€è‘‰å…¥åŠ›<br/>3-10æ–‡å­— æ—¥æœ¬èªå¯]
    InputPass1 --> ValidatePass1{ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³}
    ValidatePass1 -->|æ–‡å­—æ•°ä¸è¶³/è¶…é| InputPass1
    ValidatePass1 -->|OK| CheckDup1{Supabase<br/>é‡è¤‡ãƒã‚§ãƒƒã‚¯}
    CheckDup1 -->|æ—¢å­˜| Error1[ã‚¨ãƒ©ãƒ¼:<br/>æ—¢ã«å­˜åœ¨ã™ã‚‹åˆè¨€è‘‰]
    Error1 --> InputPass1
    CheckDup1 -->|æ–°è¦| CreateRoomDB[Databaseã«<br/>ãƒ«ãƒ¼ãƒ ä½œæˆ]
    CreateRoomDB --> InputNick1[ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å…¥åŠ›]
    InputNick1 --> CreateHost[ãƒ›ã‚¹ãƒˆã¨ã—ã¦<br/>ãƒ«ãƒ¼ãƒ å‚åŠ ]
    CreateHost --> Lobby[ãƒ­ãƒ“ãƒ¼ç”»é¢]
    
    JoinBtn --> InputPass2[åˆè¨€è‘‰å…¥åŠ›]
    InputPass2 --> CheckExist{Supabase<br/>ãƒ«ãƒ¼ãƒ å­˜åœ¨ç¢ºèª}
    CheckExist -->|å­˜åœ¨ã—ãªã„| Error2[ã‚¨ãƒ©ãƒ¼:<br/>éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“]
    Error2 --> InputPass2
    CheckExist -->|å­˜åœ¨| InputNick2[ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å…¥åŠ›]
    InputNick2 --> CheckNick{åŒã˜éƒ¨å±‹å†…<br/>é‡è¤‡ãƒã‚§ãƒƒã‚¯}
    CheckNick -->|é‡è¤‡| AddSuffix[ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã«<br/>-2ã‚’ä»˜åŠ ]
    CheckNick -->|é‡è¤‡ãªã—| JoinPlayer
    AddSuffix --> JoinPlayer[ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦<br/>ãƒ«ãƒ¼ãƒ å‚åŠ ]
    JoinPlayer --> Lobby
```

### 2-2. ãƒ­ãƒ“ãƒ¼ãƒ»ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TD
    Lobby[ãƒ­ãƒ“ãƒ¼ç”»é¢] --> ShowPlayers[å‚åŠ è€…ä¸€è¦§è¡¨ç¤º<br/>ãƒ›ã‚¹ãƒˆã«ãƒãƒƒã‚¸è¡¨ç¤º]
    
    ShowPlayers --> WaitAction{ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¾…æ©Ÿ}
    
    WaitAction -->|æ–°è¦å‚åŠ è€…| AddPlayer[Realtimeå—ä¿¡<br/>å‚åŠ è€…è¿½åŠ ]
    AddPlayer --> ShowPlayers
    
    WaitAction -->|å‚åŠ è€…é€€å‡º| RemovePlayer[Realtimeå—ä¿¡<br/>å‚åŠ è€…å‰Šé™¤]
    RemovePlayer --> ShowPlayers
    
    WaitAction -->|ãƒ›ã‚¹ãƒˆ: é–‹å§‹ãƒœã‚¿ãƒ³| CheckCount{å‚åŠ è€…æ•°<br/>3-15äºº?}
    CheckCount -->|2äººä»¥ä¸‹| ErrorCount[ã‚¨ãƒ©ãƒ¼è¡¨ç¤º:<br/>3äººä»¥ä¸Šå¿…è¦]
    ErrorCount --> WaitAction
    CheckCount -->|16äººä»¥ä¸Š| ErrorCount2[ã‚¨ãƒ©ãƒ¼è¡¨ç¤º:<br/>15äººä»¥ä¸‹ã«ã—ã¦ãã ã•ã„]
    ErrorCount2 --> WaitAction
    CheckCount -->|3-15äºº| SelectDifficulty[é›£æ˜“åº¦é¸æŠç”»é¢]
    
    SelectDifficulty --> ConfirmStart{ãƒ›ã‚¹ãƒˆç¢ºèª}
    ConfirmStart -->|ã‚­ãƒ£ãƒ³ã‚»ãƒ«| WaitAction
    ConfirmStart -->|OK| StartGame[ã‚²ãƒ¼ãƒ é–‹å§‹ã‚¤ãƒ™ãƒ³ãƒˆ<br/>Realtimeé€ä¿¡]
    StartGame --> DealRoles[å½¹è·é…å¸ƒãƒ•ã‚§ãƒ¼ã‚º]
    
    WaitAction -->|å†é–‹ãƒœã‚¿ãƒ³<br/>è¡¨ç¤ºæ™‚| ResumeCheck{ä¸­æ–­ãƒ‡ãƒ¼ã‚¿å­˜åœ¨?}
    ResumeCheck -->|ãªã—| WaitAction
    ResumeCheck -->|ã‚ã‚Š| ResumeMember{ãƒ¡ãƒ³ãƒãƒ¼<br/>å…¨å“¡å‚åŠ ?}
    ResumeMember -->|ä¸è¶³| ErrorResume[ã‚¨ãƒ©ãƒ¼:<br/>å…¨å“¡æƒã£ã¦ã‹ã‚‰å†é–‹]
    ErrorResume --> WaitAction
    ResumeMember -->|å…¨å“¡| Resume[ä¸­æ–­ãƒ•ã‚§ãƒ¼ã‚ºã«<br/>å¾©å¸°]
```

### 2-3. å½¹è·é…å¸ƒãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TD
    DealRoles[å½¹è·é…å¸ƒãƒ•ã‚§ãƒ¼ã‚º] --> GetHistory{å‰å›ã®å±¥æ­´å–å¾—<br/>Supabase Database}
    
    GetHistory --> CheckPrevMaster{å‰å›ãƒã‚¹ã‚¿ãƒ¼<br/>å­˜åœ¨?}
    CheckPrevMaster -->|ãªã—| RandomAll[å…¨å“¡ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ é¸å‡º]
    CheckPrevMaster -->|ã‚ã‚Š| ExcludeMaster[å‰å›ãƒã‚¹ã‚¿ãƒ¼ã‚’é™¤å¤–<br/>æ®‹ã‚Šã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ é¸å‡º]
    
    RandomAll --> SelectMaster[ãƒã‚¹ã‚¿ãƒ¼1äººé¸å‡º]
    ExcludeMaster --> SelectMaster
    
    SelectMaster --> SelectInsider[æ®‹ã‚Šã‹ã‚‰<br/>ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼1äººé¸å‡º]
    SelectInsider --> SetCitizens[æ®‹ã‚Šå…¨å“¡ã‚’<br/>åº¶æ°‘ã«è¨­å®š]
    
    SetCitizens --> SaveRoles[å½¹è·ã‚’Databaseä¿å­˜<br/>å±¥æ­´ã‚‚æ›´æ–°]
    SaveRoles --> SendRoles[å„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«<br/>å€‹åˆ¥é€ä¿¡ via Realtime]
    
    SendRoles --> ShowRole1[ãƒã‚¹ã‚¿ãƒ¼:<br/>ã€Œã‚ãªãŸã¯ãƒã‚¹ã‚¿ãƒ¼ã§ã™!ã€<br/>ã‚«ãƒ¼ãƒ‰è¡¨ç¤º]
    SendRoles --> ShowRole2[ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼:<br/>ã€Œã‚ãªãŸã¯ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼ã§ã™ç›®ã€<br/>ã‚«ãƒ¼ãƒ‰è¡¨ç¤º]
    SendRoles --> ShowRole3[åº¶æ°‘:<br/>ã€Œã‚ãªãŸã¯åº¶æ°‘ã§ã™?ã€<br/>ã‚«ãƒ¼ãƒ‰è¡¨ç¤º]
    
    ShowRole1 --> AllConfirm
    ShowRole2 --> AllConfirm
    ShowRole3 --> AllConfirm
    
    AllConfirm{å…¨å“¡ç¢ºèªå®Œäº†?} -->|æœªå®Œäº†| WaitConfirm[å¾…æ©Ÿ]
    WaitConfirm --> AllConfirm
    AllConfirm -->|å®Œäº†| TopicPhase[ãŠé¡Œç¢ºèªãƒ•ã‚§ãƒ¼ã‚º]
```

### 2-4. ãŠé¡Œç¢ºèªãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TD
    TopicPhase[ãŠé¡Œç¢ºèªãƒ•ã‚§ãƒ¼ã‚º] --> GetDifficulty[é¸æŠã•ã‚ŒãŸé›£æ˜“åº¦å–å¾—]
    
    GetDifficulty --> FilterTopics[é›£æ˜“åº¦ã«å¿œã˜ãŸ<br/>ãŠé¡Œãƒªã‚¹ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿]
    FilterTopics --> ExcludeUsed[ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ä½¿ç”¨æ¸ˆã¿<br/>ãŠé¡Œã‚’é™¤å¤–]
    
    ExcludeUsed --> RandomSelect[æ®‹ã‚Šã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ]
    RandomSelect --> SaveTopic[ãŠé¡Œã‚’Databaseä¿å­˜<br/>ä½¿ç”¨æ¸ˆã¿ã«è¿½åŠ ]
    
    SaveTopic --> SendMaster[ãƒã‚¹ã‚¿ãƒ¼ã®ã¿ã«é€ä¿¡<br/>Realtimeå€‹åˆ¥é€ä¿¡]
    SendMaster --> ShowMaster[ãƒã‚¹ã‚¿ãƒ¼ç”»é¢:<br/>ãŠé¡Œã‚’å¸¸æ™‚è¡¨ç¤º<br/>å°ã•ã‚å›ºå®šä½ç½®]
    
    SaveTopic --> SendInsider[ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼ã®ã¿ã«é€ä¿¡<br/>Realtimeå€‹åˆ¥é€ä¿¡]
    SendInsider --> ShowInsider[ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼ç”»é¢:<br/>ãŠé¡Œãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—<br/>10ç§’é–“è¡¨ç¤º]
    
    SaveTopic --> SendOthers[åº¶æ°‘ã«ã¯é€ä¿¡ã—ãªã„]
    SendOthers --> ShowCitizen[åº¶æ°‘ç”»é¢:<br/>ã€ŒãŠé¡Œã‚’ç¢ºèªä¸­...ã€]
    
    ShowMaster --> WaitAll
    ShowInsider --> WaitAll
    ShowCitizen --> WaitAll
    
    WaitAll{å…¨å“¡ç¢ºèªå®Œäº†?} -->|æœªå®Œäº†| WaitAll
    WaitAll -->|å®Œäº†| QuestionPhase[è³ªå•ãƒ•ã‚§ãƒ¼ã‚º]
```

### 2-5. è³ªå•ãƒ•ã‚§ãƒ¼ã‚ºãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TD
    QuestionPhase[è³ªå•ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹] --> CalcDeadline[é–‹å§‹æ™‚åˆ» + 5åˆ†<br/>= ç· åˆ‡epochè¨ˆç®—]
    
    CalcDeadline --> SaveDeadline[ç· åˆ‡ã‚’Databaseä¿å­˜]
    SaveDeadline --> BroadcastStart[å…¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«<br/>ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹é€šçŸ¥<br/>+ ç· åˆ‡epoché€ä¿¡]
    
    BroadcastStart --> ShowTimer[å„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ:<br/>æ®‹ã‚Šæ™‚é–“è¡¨ç¤º<br/>epochå·®åˆ†ã§è¨ˆç®—]
    ShowTimer --> ShowTurn[ç™ºè¨€é †è¡¨ç¤º<br/>1äººãšã¤è³ªå•]
    
    ShowTurn --> WaitAction{ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¾…æ©Ÿ}
    
    WaitAction -->|ãƒã‚¹ã‚¿ãƒ¼: æ­£è§£å ±å‘Š| CheckTime{ã‚µãƒ¼ãƒãƒ¼æ™‚åˆ»<br/>â‰¤ ç· åˆ‡?}
    CheckTime -->|æ™‚é–“è¶…é| IgnoreCorrect[å ±å‘Šã‚’ç„¡è¦–]
    IgnoreCorrect --> WaitAction
    CheckTime -->|æ™‚é–“å†…| RecordCorrect[æ­£è§£è€…ã‚’è¨˜éŒ²<br/>Databaseä¿å­˜]
    RecordCorrect --> CalcElapsed[çµŒéæ™‚é–“è¨ˆç®—:<br/>é–‹å§‹ã€œæ­£è§£å ±å‘Š]
    CalcElapsed --> CalcDebate[è¨è«–æ™‚é–“ =<br/>5åˆ† - çµŒéæ™‚é–“]
    CalcDebate --> DebatePhase[è¨è«–ãƒ•ã‚§ãƒ¼ã‚ºã¸]
    
    WaitAction -->|ã‚¿ã‚¤ãƒãƒ¼: 0ç§’| Timeout[ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ]
    Timeout --> SetAllLose[çµæœ: å…¨å“¡æ•—åŒ—<br/>Databaseä¿å­˜]
    SetAllLose --> Result[çµæœç”»é¢]
    
    WaitAction -->|ãƒ›ã‚¹ãƒˆ: ä¸­æ–­| Suspend[ä¸­æ–­å‡¦ç†]
    WaitAction -->|ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é›¢è„±| HandleLeave[é›¢è„±å‡¦ç†]
    HandleLeave -->|æ­£è§£è€…| DebatePhase
    HandleLeave -->|ãã‚Œä»¥å¤–| WaitAction
```

### 2-6. è¨è«–ãƒ•ã‚§ãƒ¼ã‚ºãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TD
    DebatePhase[è¨è«–ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹] --> GetRemain[æ®‹ã‚Šæ™‚é–“ã‚’å–å¾—<br/>è³ªå•ãƒ•ã‚§ãƒ¼ã‚ºã‹ã‚‰å¼•ç¶™ã]
    
    GetRemain --> CalcDeadline2[ç¾åœ¨æ™‚åˆ» + æ®‹ã‚Šæ™‚é–“<br/>= ç· åˆ‡epochè¨ˆç®—]
    CalcDeadline2 --> SaveDeadline2[ç· åˆ‡ã‚’Databaseä¿å­˜]
    SaveDeadline2 --> BroadcastDebate[å…¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€šçŸ¥<br/>æ­£è§£è€…ãƒã‚¤ãƒ©ã‚¤ãƒˆ<br/>+ ç· åˆ‡epoch]
    
    BroadcastDebate --> ShowTimer2[æ®‹ã‚Šæ™‚é–“è¡¨ç¤º]
    ShowTimer2 --> ShowCorrector[æ­£è§£è€…ã‚’å¼·èª¿è¡¨ç¤º]
    ShowCorrector --> Discussion[è‡ªç”±è¨è«–<br/>ã‚¢ãƒ—ãƒªã¯ä»‹å…¥ã—ãªã„]
    
    Discussion --> WaitEnd{çµ‚äº†å¾…æ©Ÿ}
    
    WaitEnd -->|ã‚¿ã‚¤ãƒãƒ¼: 0ç§’| AutoEnd[è‡ªå‹•çµ‚äº†]
    WaitEnd -->|ãƒ›ã‚¹ãƒˆ: è¨è«–çµ‚äº†| ManualEnd[æ‰‹å‹•çµ‚äº†]
    
    AutoEnd --> Vote1Phase[ç¬¬ä¸€æŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚º]
    ManualEnd --> Vote1Phase
    
    WaitEnd -->|ãƒ›ã‚¹ãƒˆ: ä¸­æ–­| Suspend2[ä¸­æ–­å‡¦ç†]
    WaitEnd -->|ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é›¢è„±| HandleLeave2[é›¢è„±å‡¦ç†<br/>è¨è«–ç¶šè¡Œ]
    HandleLeave2 --> WaitEnd
```

### 2-7. ç¬¬ä¸€æŠ•ç¥¨ãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TD
    Vote1Phase[ç¬¬ä¸€æŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚º] --> ShowQuestion[ç”»é¢è¡¨ç¤º:<br/>ã€Œæ­£è§£è€…ã‚’ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼ã¨ã—ã¦<br/>å‘Šç™ºã—ã¾ã™ã‹?ã€]
    
    ShowQuestion --> ShowButtons[Yes/Noãƒœã‚¿ãƒ³è¡¨ç¤º<br/>å¤§ããªã‚¿ãƒƒãƒ—é ˜åŸŸ]
    ShowButtons --> WaitVotes{æŠ•ç¥¨å¾…æ©Ÿ}
    
    WaitVotes -->|ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: æŠ•ç¥¨| RecordVote1[æŠ•ç¥¨ã‚’Databaseè¨˜éŒ²<br/>å€‹åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«]
    RecordVote1 --> CheckComplete1{å…¨å“¡æŠ•ç¥¨å®Œäº†?}
    
    CheckComplete1 -->|æœªå®Œäº†| WaitVotes
    CheckComplete1 -->|å®Œäº†| CountVotes1[é›†è¨ˆå‡¦ç†]
    
    CountVotes1 --> CalcMajority{Yesç¥¨ãŒéåŠæ•°?<br/>|ä¸­å¤®å€¤|ç¥¨ä»¥ä¸Š}
    
    CalcMajority -->|YeséåŠæ•°| RevealCorrector[æ­£è§£è€…ã®å½¹è·ã‚’å…¬é–‹]
    RevealCorrector --> CheckInsider{ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼?}
    CheckInsider -->|Yes| CitizenWin[å‹æ•—: åº¶æ°‘å‹åˆ©]
    CheckInsider -->|No| InsiderWin1[å‹æ•—: ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼å‹åˆ©]
    CitizenWin --> Result1[çµæœç”»é¢]
    InsiderWin1 --> Result1
    
    CalcMajority -->|NoéåŠæ•°| Vote2Phase[ç¬¬äºŒæŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚º]
    
    WaitVotes -->|ãƒ›ã‚¹ãƒˆ: ä¸­æ–­| Suspend3[ä¸­æ–­å‡¦ç†]
    WaitVotes -->|ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é›¢è„±| InvalidVote[ãã®äººã®ç¥¨ã‚’ç„¡åŠ¹åŒ–<br/>é›¢è„±è€…é™¤å¤–ã—ã¦å†é›†è¨ˆ]
    InvalidVote --> CheckComplete1
```

### 2-8. ç¬¬äºŒæŠ•ç¥¨ãƒ•ãƒ­ãƒ¼ï¼ˆæ±ºé¸æŠ•ç¥¨å«ã‚€ï¼‰

```mermaid
flowchart TD
    Vote2Phase[ç¬¬äºŒæŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚º] --> ExcludePlayers[å€™è£œè€…ãƒªã‚¹ãƒˆä½œæˆ:<br/>ãƒã‚¹ã‚¿ãƒ¼ãƒ»æ­£è§£è€…ã‚’é™¤å¤–]
    
    ExcludePlayers --> ShowCandidates[å€™è£œè€…ä¸€è¦§è¡¨ç¤º<br/>ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³é¸æŠå¼]
    ShowCandidates --> WaitVotes2{æŠ•ç¥¨å¾…æ©Ÿ}
    
    WaitVotes2 -->|ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: æŠ•ç¥¨| RecordVote2[æŠ•ç¥¨ã‚’Databaseè¨˜éŒ²]
    RecordVote2 --> CheckComplete2{å…¨å“¡æŠ•ç¥¨å®Œäº†?}
    CheckComplete2 -->|æœªå®Œäº†| WaitVotes2
    
    CheckComplete2 -->|å®Œäº†| CountVotes2[é›†è¨ˆå‡¦ç†]
    CountVotes2 --> FindMax{æœ€å¤šå¾—ç¥¨è€…<br/>ç‰¹å®š?}
    
    FindMax -->|1äººã®ã¿| RevealVoted[æœ€å¤šå¾—ç¥¨è€…ã®<br/>å½¹è·ã‚’å…¬é–‹]
    RevealVoted --> CheckInsider2{ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼?}
    CheckInsider2 -->|Yes| CitizenWin2[å‹æ•—: åº¶æ°‘å‹åˆ©]
    CheckInsider2 -->|No| InsiderWin2[å‹æ•—: ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼å‹åˆ©]
    
    FindMax -->|åŒç¥¨è¤‡æ•°| CheckRound{æ±ºé¸æŠ•ç¥¨<br/>å›æ•°?}
    CheckRound -->|1å›ç›®| RunoffVote1[æ±ºé¸æŠ•ç¥¨<br/>åŒç¥¨è€…ã®ã¿ã§å†æŠ•ç¥¨]
    CheckRound -->|2å›ç›®| RunoffVote2[æ±ºé¸æŠ•ç¥¨<br/>åŒç¥¨è€…ã®ã¿ã§å†æŠ•ç¥¨]
    CheckRound -->|3å›ç›®| InsiderEscape[3å›åŒç¥¨<br/>ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼é€ƒã’åˆ‡ã‚Šå‹åˆ©]
    
    RunoffVote1 --> CountVotes2
    RunoffVote2 --> CountVotes2
    
    CitizenWin2 --> Result2[çµæœç”»é¢]
    InsiderWin2 --> Result2
    InsiderEscape --> Result2
    
    WaitVotes2 -->|ãƒ›ã‚¹ãƒˆ: å†æŠ•ç¥¨| CheckRetry{å†æŠ•ç¥¨æ¨©<br/>æ®‹ã£ã¦ã„ã‚‹?}
    CheckRetry -->|ä½¿ç”¨æ¸ˆã¿| IgnoreRetry[ç„¡è¦–]
    IgnoreRetry --> WaitVotes2
    CheckRetry -->|æœªä½¿ç”¨| ResetVotes[æŠ•ç¥¨ã‚’ãƒªã‚»ãƒƒãƒˆ<br/>å†æŠ•ç¥¨æ¨©æ¶ˆè²»]
    ResetVotes --> ShowCandidates
    
    WaitVotes2 -->|ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é›¢è„±| InvalidVote2[ãã®äººã®ç¥¨ã‚’ç„¡åŠ¹åŒ–]
    InvalidVote2 --> CheckComplete2
```

### 2-9. çµæœè¡¨ç¤ºãƒ»æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TD
    Result[çµæœç”»é¢] --> ShowOutcome[å‹æ•—è¡¨ç¤º<br/>ã€Œåº¶æ°‘å‹åˆ©!ã€ãªã©]
    
    ShowOutcome --> RevealRoles[å…¨å“¡ã®å½¹è·å…¬é–‹<br/>ãƒã‚¹ã‚¿ãƒ¼!/ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼ç›®/åº¶æ°‘?]
    RevealRoles --> ShowStats[ä»»æ„: ã‚¹ã‚³ã‚¢è¡¨ç¤º<br/>å„é™£å–¶ã®ç´¯è¨ˆå‹åˆ©æ•°]
    
    ShowStats --> HostAction{ãƒ›ã‚¹ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³}
    
    HostAction -->|æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰| CheckMembers{å‚åŠ è€…å¤‰å‹•?}
    CheckMembers -->|åŒã˜| ResetGame[ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ<br/>å½¹è·å±¥æ­´ã®ã¿ä¿æŒ]
    CheckMembers -->|å¤‰å‹•ã‚ã‚Š| ConfirmContinue[ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°:<br/>ãƒ¡ãƒ³ãƒãƒ¼å¤‰æ›´ã‚ã‚Š]
    ConfirmContinue -->|OK| ResetGame
    ConfirmContinue -->|ã‚­ãƒ£ãƒ³ã‚»ãƒ«| HostAction
    
    ResetGame --> DealRoles[å½¹è·é…å¸ƒãƒ•ã‚§ãƒ¼ã‚º]
    
    HostAction -->|ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹| BackLobby[ãƒ­ãƒ“ãƒ¼ç”»é¢<br/>å‚åŠ è€…ç¶­æŒ]
    
    HostAction -->|è§£æ•£| ConfirmDisband{è§£æ•£ç¢ºèª<br/>ãƒ€ã‚¤ã‚¢ãƒ­ã‚°}
    ConfirmDisband -->|ã‚­ãƒ£ãƒ³ã‚»ãƒ«| HostAction
    ConfirmDisband -->|OK| DeleteRoom[Databaseã‹ã‚‰<br/>ãƒ«ãƒ¼ãƒ å‰Šé™¤]
    DeleteRoom --> NotifyAll[å…¨å“¡ã«é€šçŸ¥<br/>Realtime]
    NotifyAll --> TopPage[å„è‡ªãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸]
```

### 2-10. ä¸­æ–­ãƒ»å†é–‹ãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TD
    AnyPhase[ä»»æ„ã®ãƒ•ã‚§ãƒ¼ã‚º] --> HostSuspend{ãƒ›ã‚¹ãƒˆ:<br/>ä¸­æ–­ãƒœã‚¿ãƒ³}
    
    HostSuspend -->|æŠ¼ä¸‹| ConfirmSuspend{ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°}
    ConfirmSuspend -->|ã‚­ãƒ£ãƒ³ã‚»ãƒ«| AnyPhase
    ConfirmSuspend -->|OK| SaveState[ç¾åœ¨ã®çŠ¶æ…‹ã‚’<br/>Databaseä¿å­˜<br/>ãƒ•ã‚§ãƒ¼ã‚º/ã‚¿ã‚¤ãƒãƒ¼/æŠ•ç¥¨çŠ¶æ³]
    
    SaveState --> NotifySuspend[å…¨å“¡ã«ä¸­æ–­é€šçŸ¥<br/>Realtime]
    NotifySuspend --> ReturnLobby[å…¨å“¡ãƒ­ãƒ“ãƒ¼ã«ç§»å‹•<br/>ã€Œå¯¾æˆ¦ã‚’å†é–‹ã€ãƒœã‚¿ãƒ³è¡¨ç¤º]
    
    ReturnLobby --> WaitResume{å¾…æ©Ÿ}
    
    WaitResume -->|å‚åŠ è€…å¢—æ¸›| UpdateMembers[å‚åŠ è€…ãƒªã‚¹ãƒˆæ›´æ–°<br/>å†é–‹ä¸å¯çŠ¶æ…‹ç¶­æŒ]
    UpdateMembers --> WaitResume
    
    WaitResume -->|ãƒ›ã‚¹ãƒˆ: å†é–‹ãƒœã‚¿ãƒ³| CheckResumeMembers{ä¸­æ–­æ™‚ã®<br/>ãƒ¡ãƒ³ãƒãƒ¼å…¨å“¡?}
    CheckResumeMembers -->|ä¸è¶³| ErrorResume2[ã‚¨ãƒ©ãƒ¼è¡¨ç¤º:<br/>å…¨å“¡æƒã£ã¦ã„ã¾ã›ã‚“]
    ErrorResume2 --> WaitResume
    
    CheckResumeMembers -->|å…¨å“¡| LoadState[ä¿å­˜çŠ¶æ…‹ã‚’èª­è¾¼<br/>Database]
    LoadState --> RestorePhase[è©²å½“ãƒ•ã‚§ãƒ¼ã‚ºã«é·ç§»]
    RestorePhase --> RestoreTimer{ã‚¿ã‚¤ãƒãƒ¼<br/>æ®‹ã£ã¦ã„ãŸ?}
    
    RestoreTimer -->|Yes| RecalcDeadline[æ®‹ã‚Šæ™‚é–“ã‚’å†è¨ˆç®—<br/>ç¾åœ¨æ™‚åˆ» + æ®‹ã‚Šç§’æ•°]
    RestoreTimer -->|No| RestoreVote[æŠ•ç¥¨çŠ¶æ…‹ã‚’å¾©å…ƒ]
    
    RecalcDeadline --> NotifyResume[å…¨å“¡ã«å†é–‹é€šçŸ¥<br/>+ æ–°ç· åˆ‡epoch]
    RestoreVote --> NotifyResume
    NotifyResume --> ResumedPhase[è©²å½“ãƒ•ã‚§ãƒ¼ã‚ºç¶šè¡Œ]
```

---

## 3. ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³

### 3-1. éƒ¨å±‹ä½œæˆãƒ»å‚åŠ ã‚·ãƒ¼ã‚±ãƒ³ã‚¹

```mermaid
sequenceDiagram
    participant C1 as ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ1<br/>(ãƒ›ã‚¹ãƒˆ)
    participant C2 as ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ2<br/>(å‚åŠ è€…)
    participant SB as Supabase<br/>(Realtime + DB)
    
    Note over C1: éƒ¨å±‹ã‚’ä½œã‚‹
    C1->>C1: åˆè¨€è‘‰å…¥åŠ›(3-10æ–‡å­—)
    C1->>SB: é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚¯ã‚¨ãƒª
    SB-->>C1: é‡è¤‡ãªã—
    C1->>SB: rooms ãƒ†ãƒ¼ãƒ–ãƒ«ã«<br/>INSERT (passphrase, host_id)
    SB-->>C1: ãƒ«ãƒ¼ãƒ IDè¿”å´
    C1->>C1: ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å…¥åŠ›
    C1->>SB: players ãƒ†ãƒ¼ãƒ–ãƒ«ã«<br/>INSERT (room_id, nickname, is_host=true)
    SB-->>C1: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDè¿”å´
    C1->>SB: Realtimeè³¼èª­é–‹å§‹<br/>room:{roomId}
    SB-->>C1: è³¼èª­ç¢ºç«‹
    C1->>C1: ãƒ­ãƒ“ãƒ¼ç”»é¢è¡¨ç¤º
    
    Note over C2: éƒ¨å±‹ã‚’æ¢ã™
    C2->>C2: åˆè¨€è‘‰å…¥åŠ›
    C2->>SB: å­˜åœ¨ç¢ºèªã‚¯ã‚¨ãƒª<br/>WHERE passphrase = ?
    SB-->>C2: ãƒ«ãƒ¼ãƒ IDè¿”å´
    C2->>C2: ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å…¥åŠ›
    C2->>SB: é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚¯ã‚¨ãƒª<br/>WHERE room_id = ? AND nickname = ?
    SB-->>C2: é‡è¤‡ã‚ã‚Š
    C2->>C2: ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã«-2ä»˜åŠ 
    C2->>SB: players ãƒ†ãƒ¼ãƒ–ãƒ«ã«<br/>INSERT
    SB-->>C2: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDè¿”å´
    C2->>SB: Realtimeè³¼èª­é–‹å§‹<br/>room:{roomId}
    SB-->>C2: è³¼èª­ç¢ºç«‹
    
    SB->>C1: Realtimeé€šçŸ¥<br/>players INSERT
    C1->>C1: å‚åŠ è€…ãƒªã‚¹ãƒˆæ›´æ–°
    SB->>C2: Realtimeé€šçŸ¥<br/>å…¨å‚åŠ è€…ãƒ‡ãƒ¼ã‚¿
    C2->>C2: ãƒ­ãƒ“ãƒ¼ç”»é¢è¡¨ç¤º
```

### 3-2. ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ»å½¹è·é…å¸ƒã‚·ãƒ¼ã‚±ãƒ³ã‚¹

```mermaid
sequenceDiagram
    participant H as ãƒ›ã‚¹ãƒˆ<br/>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    participant P as å‚åŠ è€…<br/>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    participant SB as Supabase<br/>(Realtime + DB)
    
    H->>H: é–‹å§‹ãƒœã‚¿ãƒ³æŠ¼ä¸‹
    H->>SB: äººæ•°ãƒã‚§ãƒƒã‚¯ã‚¯ã‚¨ãƒª
    SB-->>H: 3-15äººç¢ºèª
    H->>H: é›£æ˜“åº¦é¸æŠ(Easy/Normal/Hard)
    H->>SB: game_sessions ãƒ†ãƒ¼ãƒ–ãƒ«ã«<br/>INSERT (room_id, difficulty)
    SB-->>H: ã‚»ãƒƒã‚·ãƒ§ãƒ³IDè¿”å´
    
    H->>SB: å‰å›ã®å½¹è·å±¥æ­´å–å¾—<br/>SELECT prev_master FROM sessions
    SB-->>H: å‰å›ãƒã‚¹ã‚¿ãƒ¼IDè¿”å´
    
    H->>H: å½¹è·é…å¸ƒãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ<br/>å‰å›ãƒã‚¹ã‚¿ãƒ¼é™¤å¤–ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ 
    H->>SB: roles ãƒ†ãƒ¼ãƒ–ãƒ«ã«<br/>INSERT (session_id, player_id, role)
    SB-->>H: ç™»éŒ²å®Œäº†
    
    H->>SB: phaseæ›´æ–°<br/>UPDATE rooms SET phase='DEAL'
    SB->>H: Realtimeé€šçŸ¥<br/>phaseå¤‰æ›´
    SB->>P: Realtimeé€šçŸ¥<br/>phaseå¤‰æ›´
    
    H->>H: å½¹è·é…å¸ƒç”»é¢é·ç§»
    P->>P: å½¹è·é…å¸ƒç”»é¢é·ç§»
    
    SB->>H: Realtimeé€šçŸ¥<br/>roles INSERT (è‡ªåˆ†ã®å½¹è·ã®ã¿)
    SB->>P: Realtimeé€šçŸ¥<br/>roles INSERT (è‡ªåˆ†ã®å½¹è·ã®ã¿)
    
    H->>H: å½¹è·ã‚«ãƒ¼ãƒ‰è¡¨ç¤º<br/>ã€Œã‚ãªãŸã¯åº¶æ°‘ã§ã™?ã€
    P->>P: å½¹è·ã‚«ãƒ¼ãƒ‰è¡¨ç¤º<br/>ã€Œã‚ãªãŸã¯ãƒã‚¹ã‚¿ãƒ¼ã§ã™!ã€
    
    H->>SB: ç¢ºèªå®Œäº†é€šçŸ¥<br/>UPDATE players SET confirmed=true
    P->>SB: ç¢ºèªå®Œäº†é€šçŸ¥<br/>UPDATE players SET confirmed=true
    
    SB->>H: Realtimeé€šçŸ¥<br/>confirmedæ›´æ–°
    SB->>P: Realtimeé€šçŸ¥<br/>confirmedæ›´æ–°
    
    Note over SB: å…¨å“¡confirmed=trueç¢ºèª
    SB->>H: Realtimeé€šçŸ¥<br/>phase='TOPIC'
    SB->>P: Realtimeé€šçŸ¥<br/>phase='TOPIC'
```

### 3-3. ãŠé¡Œç¢ºèªã‚·ãƒ¼ã‚±ãƒ³ã‚¹

```mermaid
sequenceDiagram
    participant M as ãƒã‚¹ã‚¿ãƒ¼
    participant I as ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼
    participant C as åº¶æ°‘
    participant SB as Supabase
    
    Note over SB: phase='TOPIC'ç§»è¡Œå¾Œ
    
    SB->>SB: é›£æ˜“åº¦ã«å¿œã˜ãŸãŠé¡Œãƒ•ã‚£ãƒ«ã‚¿
    SB->>SB: ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ä½¿ç”¨æ¸ˆã¿é™¤å¤–
    SB->>SB: ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
    SB->>SB: topics ãƒ†ãƒ¼ãƒ–ãƒ«ã«<br/>INSERT (session_id, topic_text)
    SB->>SB: used_topics ã«è¿½åŠ 
    
    SB->>M: Realtimeé€šçŸ¥<br/>topics INSERT (è‡ªåˆ†ã ã‘)
    M->>M: ãŠé¡Œã‚’å¸¸æ™‚è¡¨ç¤º<br/>ç”»é¢ä¸Šéƒ¨ã«å›ºå®š
    M->>SB: ç¢ºèªå®Œäº†é€šçŸ¥<br/>confirmed=true
    
    SB->>I: Realtimeé€šçŸ¥<br/>topics INSERT (è‡ªåˆ†ã ã‘)
    I->>I: ãŠé¡Œãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º<br/>10ç§’é–“
    I->>I: 10ç§’å¾Œè‡ªå‹•æ¶ˆå»
    I->>SB: ç¢ºèªå®Œäº†é€šçŸ¥<br/>confirmed=true
    
    C->>C: ã€ŒãŠé¡Œã‚’ç¢ºèªä¸­...ã€è¡¨ç¤º
    C->>SB: ç¢ºèªå®Œäº†é€šçŸ¥<br/>confirmed=true
    
    Note over SB: å…¨å“¡confirmed=trueç¢ºèª
    SB->>M: Realtimeé€šçŸ¥<br/>phase='QUESTION'<br/>+ deadline_epoch
    SB->>I: Realtimeé€šçŸ¥<br/>phase='QUESTION'<br/>+ deadline_epoch
    SB->>C: Realtimeé€šçŸ¥<br/>phase='QUESTION'<br/>+ deadline_epoch
```

### 3-4. è³ªå•ãƒ•ã‚§ãƒ¼ã‚ºã‚·ãƒ¼ã‚±ãƒ³ã‚¹

```mermaid
sequenceDiagram
    participant M as ãƒã‚¹ã‚¿ãƒ¼
    participant P as ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
    participant SB as Supabase
    participant T as ã‚¿ã‚¤ãƒãƒ¼ç›£è¦–<br/>(ã‚µãƒ¼ãƒãƒ¼å´)
    
    Note over SB: phase='QUESTION'ç§»è¡Œ
    SB->>SB: é–‹å§‹æ™‚åˆ»è¨˜éŒ²<br/>start_time = now()
    SB->>SB: ç· åˆ‡è¨ˆç®—<br/>deadline = now() + 5min
    SB->>SB: UPDATE sessions<br/>SET phase='QUESTION', deadline
    
    SB->>M: Realtimeé€šçŸ¥<br/>deadline_epoch
    SB->>P: Realtimeé€šçŸ¥<br/>deadline_epoch
    
    M->>M: æ®‹ã‚Šæ™‚é–“è¡¨ç¤ºé–‹å§‹<br/>ãƒ­ãƒ¼ã‚«ãƒ«è¨ˆç®—
    P->>P: æ®‹ã‚Šæ™‚é–“è¡¨ç¤ºé–‹å§‹<br/>ãƒ­ãƒ¼ã‚«ãƒ«è¨ˆç®—
    
    loop è³ªå•ãƒ»å›ç­”
        P->>M: å£é ­ã§è³ªå•<br/>(Discordç­‰)
        M->>P: å£é ­ã§å›ç­”<br/>(Discordç­‰)
    end
    
    Note over M: æ­£è§£ãŒå‡ºãŸ
    M->>SB: æ­£è§£å ±å‘Š<br/>POST /correct<br/>{ answerer_id }
    
    SB->>SB: ã‚µãƒ¼ãƒãƒ¼æ™‚åˆ»ãƒã‚§ãƒƒã‚¯<br/>now() <= deadline ?
    
    alt æ™‚é–“å†…
        SB->>SB: çµŒéæ™‚é–“è¨ˆç®—<br/>elapsed = now() - start_time
        SB->>SB: è¨è«–æ™‚é–“è¨ˆç®—<br/>debate_time = 5min - elapsed
        SB->>SB: UPDATE sessions<br/>SET phase='DEBATE',<br/>answerer_id,<br/>deadline = now() + debate_time
        
        SB->>M: Realtimeé€šçŸ¥<br/>phase='DEBATE'<br/>+ æ–°deadline_epoch
        SB->>P: Realtimeé€šçŸ¥<br/>phase='DEBATE'<br/>+ æ–°deadline_epoch<br/>+ answerer_id
        
        M->>M: è¨è«–ç”»é¢é·ç§»
        P->>P: è¨è«–ç”»é¢é·ç§»<br/>æ­£è§£è€…ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    else æ™‚é–“è¶…é
        SB-->>M: ã‚¨ãƒ©ãƒ¼å¿œç­”<br/>ã€Œæ™‚é–“åˆ‡ã‚Œã€
    end
    
    T->>T: deadlineåˆ°é”ç›£è¦–
    alt ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
        T->>SB: UPDATE sessions<br/>SET phase='RESULT',<br/>outcome='ALL_LOSE'
        SB->>M: Realtimeé€šçŸ¥<br/>phase='RESULT'<br/>outcome='ALL_LOSE'
        SB->>P: Realtimeé€šçŸ¥<br/>phase='RESULT'<br/>outcome='ALL_LOSE'
    end
```

### 3-5. æŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚ºã‚·ãƒ¼ã‚±ãƒ³ã‚¹ï¼ˆç¬¬ä¸€ãƒ»ç¬¬äºŒæŠ•ç¥¨ï¼‰

```mermaid
sequenceDiagram
    participant P1 as ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1
    participant P2 as ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2
    participant SB as Supabase
    
    Note over SB: phase='DEBATE'çµ‚äº†
    SB->>SB: UPDATE sessions<br/>SET phase='VOTE1'
    SB->>P1: Realtimeé€šçŸ¥<br/>phase='VOTE1'
    SB->>P2: Realtimeé€šçŸ¥<br/>phase='VOTE1'
    
    P1->>P1: ã€Œæ­£è§£è€…ã‚’ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼ã¨ã—ã¦<br/>å‘Šç™ºã—ã¾ã™ã‹?ã€è¡¨ç¤º
    P2->>P2: åŒã˜ç”»é¢è¡¨ç¤º
    
    P1->>SB: æŠ•ç¥¨<br/>POST /vote1<br/>{ vote: 'yes' }
    SB->>SB: votes ãƒ†ãƒ¼ãƒ–ãƒ«ã«<br/>INSERT (session_id, player_id, vote)
    SB->>P1: Realtimeé€šçŸ¥<br/>æŠ•ç¥¨æ¸ˆã¿ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    SB->>P2: Realtimeé€šçŸ¥<br/>ã€ŒP1æŠ•ç¥¨å®Œäº†ã€
    
    P2->>SB: æŠ•ç¥¨<br/>POST /vote1<br/>{ vote: 'no' }
    SB->>SB: INSERT votes
    
    Note over SB: å…¨å“¡æŠ•ç¥¨å®Œäº†æ¤œå‡º
    SB->>SB: é›†è¨ˆå‡¦ç†<br/>COUNT(vote='yes')
    SB->>SB: éåŠæ•°åˆ¤å®š<br/>yes_count > total/2 ?
    
    alt YeséåŠæ•°
        SB->>SB: æ­£è§£è€…ã®å½¹è·å–å¾—
        SB->>SB: UPDATE sessions<br/>SET phase='RESULT',<br/>revealed_player_id
        
        SB->>P1: Realtimeé€šçŸ¥<br/>phase='RESULT'<br/>+ æ­£è§£è€…å½¹è·å…¬é–‹<br/>+ å‹æ•—
        SB->>P2: Realtimeé€šçŸ¥<br/>åŒä¸Š
        
    else NoéåŠæ•°
        SB->>SB: UPDATE sessions<br/>SET phase='VOTE2'
        SB->>SB: å€™è£œè€…ãƒªã‚¹ãƒˆç”Ÿæˆ<br/>(ãƒã‚¹ã‚¿ãƒ¼ãƒ»æ­£è§£è€…é™¤å¤–)
        
        SB->>P1: Realtimeé€šçŸ¥<br/>phase='VOTE2'<br/>+ å€™è£œè€…ãƒªã‚¹ãƒˆ
        SB->>P2: Realtimeé€šçŸ¥<br/>åŒä¸Š
        
        P1->>P1: å€™è£œè€…ä¸€è¦§è¡¨ç¤º
        P2->>P2: åŒã˜ç”»é¢è¡¨ç¤º
        
        P1->>SB: æŠ•ç¥¨<br/>POST /vote2<br/>{ candidate_id }
        P2->>SB: æŠ•ç¥¨<br/>POST /vote2<br/>{ candidate_id }
        
        Note over SB: å…¨å“¡æŠ•ç¥¨å®Œäº†æ¤œå‡º
        SB->>SB: é›†è¨ˆå‡¦ç†<br/>å„å€™è£œã®å¾—ç¥¨æ•°è¨ˆç®—
        SB->>SB: æœ€å¤šå¾—ç¥¨è€…åˆ¤å®š
        
        alt æœ€å¤š1äºº
            SB->>SB: ãã®äººã®å½¹è·å–å¾—
            SB->>SB: UPDATE sessions<br/>SET phase='RESULT'
            SB->>P1: Realtimeé€šçŸ¥<br/>çµæœ + å½¹è·å…¬é–‹
            SB->>P2: Realtimeé€šçŸ¥<br/>åŒä¸Š
            
        else åŒç¥¨è¤‡æ•°
            SB->>SB: UPDATE sessions<br/>SET phase='VOTE2_RUNOFF',<br/>runoff_round++
            SB->>SB: åŒç¥¨è€…ã®ã¿ãƒªã‚¹ãƒˆåŒ–
            
            alt 3å›ç›®åŒç¥¨
                SB->>SB: UPDATE sessions<br/>SET phase='RESULT',<br/>outcome='INSIDER_WIN'
                SB->>P1: Realtimeé€šçŸ¥<br/>ã€Œã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼é€ƒã’åˆ‡ã‚Šã€
                SB->>P2: Realtimeé€šçŸ¥<br/>åŒä¸Š
            else 1-2å›ç›®
                SB->>P1: Realtimeé€šçŸ¥<br/>ã€Œæ±ºé¸æŠ•ç¥¨ã€<br/>+ åŒç¥¨è€…ãƒªã‚¹ãƒˆ
                SB->>P2: Realtimeé€šçŸ¥<br/>åŒä¸Š
                Note over P1,P2: æ±ºé¸æŠ•ç¥¨ã¸<br/>(åŒã˜ãƒ•ãƒ­ãƒ¼)
            end
        end
    end
```

### 3-6. å†æŠ•ç¥¨ã‚·ãƒ¼ã‚±ãƒ³ã‚¹

```mermaid
sequenceDiagram
    participant H as ãƒ›ã‚¹ãƒˆ
    participant P as ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
    participant SB as Supabase
    
    Note over SB: ç¬¬äºŒæŠ•ç¥¨å®Œäº†å¾Œ
    SB->>H: Realtimeé€šçŸ¥<br/>æŠ•ç¥¨çµæœè¡¨ç¤º
    SB->>P: Realtimeé€šçŸ¥<br/>æŠ•ç¥¨çµæœè¡¨ç¤º
    
    H->>H: ã€Œå†æŠ•ç¥¨ã€ãƒœã‚¿ãƒ³è¡¨ç¤º<br/>(1å›ã®ã¿å¯èƒ½)
    H->>SB: å†æŠ•ç¥¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆ<br/>POST /revote
    
    SB->>SB: å†æŠ•ç¥¨æ¨©ãƒã‚§ãƒƒã‚¯<br/>retry_used = false ?
    
    alt æœªä½¿ç”¨
        SB->>SB: UPDATE sessions<br/>SET retry_used=true
        SB->>SB: DELETE FROM votes<br/>WHERE session_id AND round=current
        SB->>SB: å€™è£œè€…ãƒªã‚¹ãƒˆå†ç”Ÿæˆ<br/>(åŒã˜å€™è£œ)
        
        SB->>H: Realtimeé€šçŸ¥<br/>ã€Œå†æŠ•ç¥¨é–‹å§‹ã€<br/>+ å€™è£œè€…ãƒªã‚¹ãƒˆ
        SB->>P: Realtimeé€šçŸ¥<br/>åŒä¸Š
        
        H->>H: æŠ•ç¥¨ç”»é¢å†è¡¨ç¤º<br/>å‰å›ã®é¸æŠã¯ãƒªã‚»ãƒƒãƒˆ
        P->>P: åŒã˜ç”»é¢
        
        Note over H,P: æŠ•ç¥¨ãƒ—ãƒ­ã‚»ã‚¹å†é–‹<br/>(é€šå¸¸ã®ç¬¬äºŒæŠ•ç¥¨ã¨åŒã˜)
        
    else ä½¿ç”¨æ¸ˆã¿
        SB-->>H: ã‚¨ãƒ©ãƒ¼å¿œç­”<br/>ã€Œå†æŠ•ç¥¨æ¨©ä½¿ç”¨æ¸ˆã¿ã€
        H->>H: ã‚¨ãƒ©ãƒ¼è¡¨ç¤º<br/>ç„¡è¦–
    end
```

### 3-7. ä¸­æ–­ãƒ»å†é–‹ã‚·ãƒ¼ã‚±ãƒ³ã‚¹

```mermaid
sequenceDiagram
    participant H as ãƒ›ã‚¹ãƒˆ
    participant P as ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
    participant SB as Supabase
    
    Note over H: ä»»æ„ã®ãƒ•ã‚§ãƒ¼ã‚ºã§
    H->>H: ä¸­æ–­ãƒœã‚¿ãƒ³æŠ¼ä¸‹
    H->>H: ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
    H->>SB: ä¸­æ–­ãƒªã‚¯ã‚¨ã‚¹ãƒˆ<br/>POST /suspend
    
    SB->>SB: ç¾åœ¨çŠ¶æ…‹ã‚’ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¿å­˜<br/>suspended_state JSON:<br/>{ phase, timer_remaining,<br/>  votes, answerer_id, ... }
    SB->>SB: UPDATE rooms<br/>SET phase='LOBBY',<br/>is_suspended=true
    
    SB->>H: Realtimeé€šçŸ¥<br/>phase='LOBBY'<br/>+ suspend_flag
    SB->>P: Realtimeé€šçŸ¥<br/>åŒä¸Š
    
    H->>H: ãƒ­ãƒ“ãƒ¼ç”»é¢é·ç§»<br/>ã€Œå¯¾æˆ¦ã‚’å†é–‹ã€ãƒœã‚¿ãƒ³è¡¨ç¤º
    P->>P: åŒã˜ç”»é¢é·ç§»
    
    Note over H: ã—ã°ã‚‰ãå¾Œ...
    H->>H: ã€Œå¯¾æˆ¦ã‚’å†é–‹ã€æŠ¼ä¸‹
    H->>SB: å†é–‹å¯å¦ãƒã‚§ãƒƒã‚¯<br/>GET /can_resume
    
    SB->>SB: ä¸­æ–­æ™‚ãƒ¡ãƒ³ãƒãƒ¼ã¨<br/>ç¾åœ¨ãƒ¡ãƒ³ãƒãƒ¼æ¯”è¼ƒ
    
    alt å…¨å“¡æƒã£ã¦ã„ã‚‹
        SB-->>H: å†é–‹å¯èƒ½
        H->>SB: å†é–‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆ<br/>POST /resume
        
        SB->>SB: suspended_stateèª­è¾¼
        SB->>SB: æ®‹ã‚Šæ™‚é–“å†è¨ˆç®—<br/>new_deadline = now() + remaining
        SB->>SB: UPDATE rooms<br/>SET phase=ä¿å­˜phase,<br/>is_suspended=false
        
        SB->>H: Realtimeé€šçŸ¥<br/>phaseå¾©å…ƒ<br/>+ æ–°deadline<br/>+ å…¨çŠ¶æ…‹ãƒ‡ãƒ¼ã‚¿
        SB->>P: Realtimeé€šçŸ¥<br/>åŒä¸Š
        
        H->>H: ä¸­æ–­æ™‚ã®ãƒ•ã‚§ãƒ¼ã‚ºç”»é¢ã«é·ç§»<br/>ã‚¿ã‚¤ãƒãƒ¼å†é–‹
        P->>P: åŒã˜ç”»é¢é·ç§»
        
    else ãƒ¡ãƒ³ãƒãƒ¼ä¸è¶³
        SB-->>H: å†é–‹ä¸å¯<br/>{ missing_players: [...] }
        H->>H: ã‚¨ãƒ©ãƒ¼è¡¨ç¤º<br/>ã€Œã€‡ã€‡ã•ã‚“ãŒä¸åœ¨ã§ã™ã€
    end
```

### 3-8. é›¢è„±ãƒ»å†æ¥ç¶šã‚·ãƒ¼ã‚±ãƒ³ã‚¹

```mermaid
sequenceDiagram
    participant P as ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
    participant SB as Supabase
    participant O as ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
    
    Note over P: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ‡æ–­
    P->>P: æ¥ç¶šæ–­æ¤œçŸ¥
    P->>P: ã€Œå†æ¥ç¶šä¸­...ã€è¡¨ç¤º
    
    SB->>SB: Heartbeat timeoutæ¤œå‡º
    SB->>SB: UPDATE players<br/>SET is_connected=false
    
    SB->>O: Realtimeé€šçŸ¥<br/>ã€ŒPã•ã‚“åˆ‡æ–­ã€
    O->>O: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã«<br/>ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆè¡¨ç¤º
    
    Note over P: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¾©æ—§
    P->>SB: å†æ¥ç¶šãƒªã‚¯ã‚¨ã‚¹ãƒˆ<br/>GET /reconnect<br/>{ player_id, room_id }
    
    SB->>SB: ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼
    SB->>SB: ç¾åœ¨ãƒ•ã‚§ãƒ¼ã‚ºå–å¾—
    SB-->>P: å†æ¥ç¶šOK<br/>+ ç¾åœ¨çŠ¶æ…‹ãƒ‡ãƒ¼ã‚¿
    
    P->>SB: Realtimeå†è³¼èª­<br/>room:{roomId}
    SB-->>P: è³¼èª­ç¢ºç«‹
    
    SB->>SB: UPDATE players<br/>SET is_connected=true
    SB->>O: Realtimeé€šçŸ¥<br/>ã€ŒPã•ã‚“å†æ¥ç¶šã€
    O->>O: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆå¾©å…ƒ
    
    P->>P: ç¾åœ¨ãƒ•ã‚§ãƒ¼ã‚ºã«é·ç§»
    
    alt æŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚ºä¸­
        P->>P: æœªæŠ•ç¥¨ãªã‚‰æŠ•ç¥¨ç”»é¢è¡¨ç¤º
        P->>P: æŠ•ç¥¨æ¸ˆã¿ãªã‚‰çµæœå¾…ã¡ç”»é¢
    else ã‚¿ã‚¤ãƒãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºä¸­
        P->>P: æ®‹ã‚Šæ™‚é–“å†è¨ˆç®—ã—ã¦è¡¨ç¤º
    else çµæœãƒ•ã‚§ãƒ¼ã‚º
        P->>P: çµæœç”»é¢è¡¨ç¤º
    end
```

---

## 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒï¼ˆè£œè¶³ï¼‰

### 4-1. ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
-- ãƒ«ãƒ¼ãƒ 
CREATE TABLE rooms (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  passphrase TEXT NOT NULL UNIQUE, -- åˆè¨€è‘‰ï¼ˆ3-10æ–‡å­—ï¼‰
  host_id UUID REFERENCES players(id),
  phase TEXT NOT NULL DEFAULT 'LOBBY', -- LOBBY/DEAL/TOPIC/QUESTION/DEBATE/VOTE1/VOTE2/RESULT
  is_suspended BOOLEAN DEFAULT false,
  suspended_state JSONB, -- ä¸­æ–­æ™‚ã®çŠ¶æ…‹ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
CREATE TABLE players (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  room_id UUID REFERENCES rooms(id) ON DELETE CASCADE,
  nickname TEXT NOT NULL,
  is_host BOOLEAN DEFAULT false,
  is_connected BOOLEAN DEFAULT true,
  confirmed BOOLEAN DEFAULT false, -- ãƒ•ã‚§ãƒ¼ã‚ºç¢ºèªãƒ•ãƒ©ã‚°
  created_at TIMESTAMP DEFAULT now()
);

-- ã‚²ãƒ¼ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰å˜ä½ï¼‰
CREATE TABLE game_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  room_id UUID REFERENCES rooms(id) ON DELETE CASCADE,
  difficulty TEXT NOT NULL, -- Easy/Normal/Hard
  start_time TIMESTAMP,
  deadline_epoch BIGINT, -- ã‚¿ã‚¤ãƒãƒ¼ç· åˆ‡ï¼ˆepochç§’ï¼‰
  answerer_id UUID REFERENCES players(id), -- æ­£è§£è€…
  phase TEXT NOT NULL,
  prev_master_id UUID REFERENCES players(id), -- å‰å›ã®ãƒã‚¹ã‚¿ãƒ¼
  created_at TIMESTAMP DEFAULT now()
);

-- å½¹è·
CREATE TABLE roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID REFERENCES game_sessions(id) ON DELETE CASCADE,
  player_id UUID REFERENCES players(id) ON DELETE CASCADE,
  role TEXT NOT NULL, -- MASTER/INSIDER/CITIZEN
  created_at TIMESTAMP DEFAULT now(),
  UNIQUE(session_id, player_id)
);

-- ãŠé¡Œ
CREATE TABLE topics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID REFERENCES game_sessions(id) ON DELETE CASCADE,
  topic_text TEXT NOT NULL,
  difficulty TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT now()
);

-- ä½¿ç”¨æ¸ˆã¿ãŠé¡Œï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³å†…é‡è¤‡å›é¿ï¼‰
CREATE TABLE used_topics (
  session_id UUID REFERENCES game_sessions(id) ON DELETE CASCADE,
  topic_id UUID,
  PRIMARY KEY(session_id, topic_id)
);

-- æŠ•ç¥¨
CREATE TABLE votes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID REFERENCES game_sessions(id) ON DELETE CASCADE,
  player_id UUID REFERENCES players(id) ON DELETE CASCADE,
  vote_type TEXT NOT NULL, -- VOTE1/VOTE2/RUNOFF
  vote_value TEXT, -- VOTE1: yes/no, VOTE2: candidate_id
  round INT DEFAULT 1, -- æ±ºé¸æŠ•ç¥¨ã®å›æ•°
  created_at TIMESTAMP DEFAULT now()
);

-- çµæœ
CREATE TABLE results (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID REFERENCES game_sessions(id) ON DELETE CASCADE,
  outcome TEXT NOT NULL, -- CITIZENS_WIN/INSIDER_WIN/ALL_LOSE
  revealed_player_id UUID REFERENCES players(id), -- å…¬é–‹ã•ã‚ŒãŸäºº
  created_at TIMESTAMP DEFAULT now()
);
```

---

## 5. å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆReactï¼‰

- [ ] ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ï¼ˆéƒ¨å±‹ä½œæˆ/æ¤œç´¢UIï¼‰
- [ ] ãƒ­ãƒ“ãƒ¼ç”»é¢ï¼ˆå‚åŠ è€…ãƒªã‚¹ãƒˆã€é–‹å§‹ãƒœã‚¿ãƒ³ã€å†é–‹ãƒœã‚¿ãƒ³ï¼‰
- [ ] å½¹è·é…å¸ƒç”»é¢ï¼ˆã‚«ãƒ¼ãƒ‰è¡¨ç¤ºã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
- [ ] ãŠé¡Œç¢ºèªç”»é¢ï¼ˆå½¹è·åˆ¥ã®è¡¨ç¤ºåˆ¶å¾¡ï¼‰
- [ ] è³ªå•ãƒ•ã‚§ãƒ¼ã‚ºç”»é¢ï¼ˆã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã€æ­£è§£å ±å‘Šãƒœã‚¿ãƒ³ï¼‰
- [ ] è¨è«–ãƒ•ã‚§ãƒ¼ã‚ºç”»é¢ï¼ˆæ­£è§£è€…ãƒã‚¤ãƒ©ã‚¤ãƒˆã€æ®‹ã‚Šæ™‚é–“ï¼‰
- [ ] ç¬¬ä¸€æŠ•ç¥¨ç”»é¢ï¼ˆYes/Noãƒœã‚¿ãƒ³ã€é›†è¨ˆè¡¨ç¤ºï¼‰
- [ ] ç¬¬äºŒæŠ•ç¥¨ç”»é¢ï¼ˆå€™è£œè€…ãƒªã‚¹ãƒˆã€æ±ºé¸æŠ•ç¥¨UIï¼‰
- [ ] çµæœç”»é¢ï¼ˆå‹æ•—ã€å…¨å½¹è·å…¬é–‹ã€æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰/è§£æ•£ï¼‰
- [ ] ä¸­æ–­ãƒ»å†é–‹UIï¼ˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã€çŠ¶æ…‹å¾©å…ƒï¼‰
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã€å†æ¥ç¶šè¡¨ç¤ºï¼‰
- [ ] ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œï¼ˆPC/ã‚¹ãƒãƒ›ï¼‰
- [ ] ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ï¼ˆãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã€ã‚¿ãƒƒãƒ—é ˜åŸŸã€è‰²è¦šå¯¾å¿œï¼‰

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆSupabaseï¼‰

- [ ] Databaseã‚¹ã‚­ãƒ¼ãƒä½œæˆ
- [ ] Realtimeè¨­å®šï¼ˆroomå˜ä½ã®è³¼èª­ï¼‰
- [ ] RPCé–¢æ•°å®Ÿè£…ï¼ˆå½¹è·é…å¸ƒã€é›†è¨ˆå‡¦ç†ã€çŠ¶æ…‹é·ç§»ï¼‰
- [ ] Row Level Securityè¨­å®šï¼ˆå½¹è·æƒ…å ±ã®ç§˜åŒ¿ï¼‰
- [ ] Webhooks/Edge Functionsï¼ˆã‚¿ã‚¤ãƒãƒ¼ç›£è¦–ã€è‡ªå‹•é·ç§»ï¼‰
- [ ] ãŠé¡Œãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼ˆJSONâ†’Databaseï¼‰
- [ ] å†æ¥ç¶šãƒ­ã‚¸ãƒƒã‚¯
- [ ] ä¸­æ–­ãƒ»å†é–‹ãƒ­ã‚¸ãƒƒã‚¯
- [ ] æŠ•ç¥¨é›†è¨ˆãƒ»åŒç¥¨å‡¦ç†
- [ ] ãƒ­ã‚°è¨˜éŒ²ï¼ˆç›£æŸ»ç”¨ï¼‰

### ãƒ†ã‚¹ãƒˆ

- [ ] å½¹è·é…å¸ƒã®åã‚Šãƒ†ã‚¹ãƒˆï¼ˆ100å›å®Ÿè¡Œã—ã¦çµ±è¨ˆï¼‰
- [ ] åŒæ™‚æ­£è§£ã®æ’ä»–åˆ¶å¾¡ãƒ†ã‚¹ãƒˆ
- [ ] ã‚¿ã‚¤ãƒãƒ¼å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆï¼ˆ0ç§’ã€1ç§’å‰ï¼‰
- [ ] åŒç¥¨ãƒ»æ±ºé¸æŠ•ç¥¨ã®å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³
- [ ] é›¢è„±ãƒ»å†æ¥ç¶šã®å…¨ãƒ•ã‚§ãƒ¼ã‚º
- [ ] ä¸­æ–­ãƒ»å†é–‹ã®çŠ¶æ…‹å¾©å…ƒ
- [ ] å†æŠ•ç¥¨æ¨©ã®1å›åˆ¶é™
- [ ] åˆè¨€è‘‰é‡è¤‡ãƒã‚§ãƒƒã‚¯
- [ ] ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ é‡è¤‡æ™‚ã®-2ä»˜åŠ 
- [ ] è² è·ãƒ†ã‚¹ãƒˆï¼ˆ30ååŒæ™‚æ¥ç¶šï¼‰

---

## 6. è£œè¶³äº‹é …

### ã‚¿ã‚¤ãƒãƒ¼åŒæœŸã®å®Ÿè£…ä¾‹ï¼ˆReactå´ï¼‰

```typescript
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã®ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º
useEffect(() => {
  if (!deadlineEpoch) return;
  
  const interval = setInterval(() => {
    const now = Math.floor(Date.now() / 1000);
    const remaining = deadlineEpoch - now;
    
    if (remaining <= 0) {
      setTimeRemaining(0);
      clearInterval(interval);
      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§å®Ÿæ–½
    } else {
      setTimeRemaining(remaining);
    }
  }, 100); // 0.1ç§’ã”ã¨ã«æ›´æ–°
  
  return () => clearInterval(interval);
}, [deadlineEpoch]);
```

### Supabase Realtimeè³¼èª­ä¾‹

```typescript
const channel = supabase.channel(`room:${roomId}`)
  .on('postgres_changes', 
    { event: 'UPDATE', schema: 'public', table: 'rooms' },
    (payload) => {
      // ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´ã‚’æ¤œçŸ¥
      if (payload.new.phase !== currentPhase) {
        setCurrentPhase(payload.new.phase);
      }
    }
  )
  .on('postgres_changes',
    { event: 'INSERT', schema: 'public', table: 'players', filter: `room_id=eq.${roomId}` },
    (payload) => {
      // æ–°è¦å‚åŠ è€…ã‚’è¿½åŠ 
      setPlayers(prev => [...prev, payload.new]);
    }
  )
  .subscribe();
```

---

ä»¥ä¸ŠãŒã€Œã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼ã‚²ãƒ¼ãƒ  ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç‰ˆã€ã®å®Œå…¨ãªä»•æ§˜æ›¸ã¨ãªã‚Šã¾ã™ã€‚ ä¸æ˜ç‚¹ã‚„è¿½åŠ ã§è©³ç´°åŒ–ãŒå¿…è¦ãªç®‡æ‰€ãŒã‚ã‚Œã°ãŠçŸ¥ã‚‰ã›ãã ã•ã„ï¼